---
phase: 01-bhxh-gateway-xml4210
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/HIS.Application/DTOs/Insurance/InsuranceXmlDTOs.cs
  - backend/src/HIS.Infrastructure/Services/InsuranceXmlService.cs
autonomous: true
requirements: [XML-01]

must_haves:
  truths:
    - "GenerateXml1DataAsync returns real patient/claim data from DB, not partial stubs"
    - "GenerateXml2DataAsync returns real medicine data from prescriptions/dispensing"
    - "GenerateXml3DataAsync returns real service/procedure data from service requests"
    - "GenerateXml4DataAsync returns out-of-catalog medicines correctly filtered"
    - "GenerateXml5DataAsync returns prescription details with dosage instructions"
    - "XML6-XML11 and XML13-XML15 DTOs exist and generator methods query real DB data"
    - "Empty tables return empty lists (not null), satisfying the all-12-tables requirement"
  artifacts:
    - path: "backend/src/HIS.Application/DTOs/Insurance/InsuranceXmlDTOs.cs"
      provides: "All 15 XML table DTOs (XML1-XML11, XML13-XML15)"
      contains: "Xml6BloodDto"
    - path: "backend/src/HIS.Infrastructure/Services/InsuranceXmlService.cs"
      provides: "Real EF Core queries for all 15 XML table generators"
      contains: "GenerateXml6DataAsync"
  key_links:
    - from: "InsuranceXmlService.GenerateXml2DataAsync"
      to: "Prescriptions + PrescriptionDetails + Medicines"
      via: "EF Core Include/Join"
      pattern: "_context\\.Prescriptions.*Include"
    - from: "InsuranceXmlService.GenerateXml3DataAsync"
      to: "ServiceRequests + ServiceRequestDetails + Services"
      via: "EF Core Include/Join"
      pattern: "_context\\.ServiceRequests.*Include"
---

<objective>
Implement all 15 XML 4210 table data generators with real EF Core queries against the HIS database. Currently XML1 has a partial implementation and XML2-XML5, XML7 return empty lists. This plan adds the missing XML6, XML8-XML11, XML13-XML15 DTOs and implements all 15 generators with real DB queries.

Purpose: The XML data generators are the core data extraction layer. Without real data from these generators, the XML file export (Plan 03) would produce empty files. Each generator maps HIS clinical data to the BHXH-mandated XML field structure per QD 4750/2024.

Output: 15 working XML table generators pulling real data from HIS database entities
</objective>

<execution_context>
@C:/Users/ADMIN/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ADMIN/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-bhxh-gateway-xml4210/01-RESEARCH.md

<interfaces>
<!-- Existing XML DTOs that already exist (XML1-XML5, XML7) -->
From backend/src/HIS.Application/DTOs/Insurance/InsuranceXmlDTOs.cs:
```csharp
public class Xml1MedicalRecordDto { MaLk, MaBn, HoTen, NgaySinh, GioiTinh, DiaChi, MaThe, MaDkbd, GtTheTu, GtTheDen, NgayVao, NgayRa, MaBenhChinh, MaLoaiKcb, MaKhoa, TienKham, TienGiuong, TienBhyt, TienBnCct, TienNguoibenh, MaPhong }
public class Xml2MedicineDto { MaLk, Stt, MaThuoc, MaNhom, TenThuoc, DonViTinh, HamLuong, DuongDung, SoLuong, DonGia, TyLeThanhToan, ThanhTien, MaKhoa, MaBacSi, NgayYl, TienBhyt, TienBnCct, TienNguoiBenh }
public class Xml3ServiceDto { MaLk, Stt, MaDvu, MaNhom, TenDvu, DonViTinh, SoLuong, DonGia, TyLeThanhToan, ThanhTien, MaKhoa, MaBacSi, NgayYl, NgayKq, TienBhyt, TienBnCct, TienNguoiBenh }
public class Xml4OtherMedicineDto { MaLk, Stt, MaThuoc, TenThuoc, DonViTinh, HamLuong, DuongDung, SoLuong, DonGia, ThanhTien }
public class Xml5PrescriptionDto { MaLk, Stt, MaThuoc, TenThuoc, SoDk, HamLuong, SoLuong, DonGia, ThanhTien, LieuDung, CachDung, SoNgay, MaBenh, NgayKeDon }
public class Xml7ReferralDto { MaLk, Stt, SoHoSo, MaBnChuyenDi, MaCskbChuyenDi, NgayChuyenDi, MaCskbChuyenDen, LyDoChuyenVien, MaBenhChinh, MaBenhKt, TomTatKq, HuongDieuTri }
```

<!-- XmlExportConfigDto used by all generators -->
```csharp
public class XmlExportConfigDto { int Month, Year; DateTime? FromDate, ToDate; List<string>? MaLkList; int? PatientType, TreatmentType; Guid? DepartmentId; bool IncludeXml1..7; bool ValidateBeforeExport; bool CompressOutput; }
```

<!-- Key HIS entities for data extraction -->
From HIS.Core/Entities:
- InsuranceClaim: ClaimCode (=MaLk), PatientId, MedicalRecordId, InsuranceNumber, ServiceDate, DischargeDate, TreatmentType, MainDiagnosisCode, TotalAmount, InsuranceAmount, DepartmentId
- InsuranceClaimDetail: ClaimId, ItemType (1=Service,2=Medicine,3=Supply,4=Bed), ServiceId, MedicineId, ItemCode, ItemName, Quantity, UnitPrice, Amount, InsuranceAmount, PatientAmount
- MedicalRecord: PatientId, AdmissionDate, DischargeDate, MainIcdCode, MainDiagnosis, PatientType
- Prescription: MedicalRecordId, DoctorId, PrescriptionDate
- PrescriptionDetail: MedicineId, Dosage, Quantity, UnitPrice, Amount
- ServiceRequest: MedicalRecordId, RequestType, Status
- ServiceRequestDetail: ServiceId, Quantity, UnitPrice, Amount, Status
- Patient: PatientCode, FullName, DateOfBirth, Gender, Address, InsuranceNumber
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add missing XML table DTOs (XML6, XML8-XML11, XML13-XML15) and extend IInsuranceXmlService</name>
  <files>
    backend/src/HIS.Application/DTOs/Insurance/InsuranceXmlDTOs.cs
    backend/src/HIS.Application/Services/IInsuranceXmlService.cs
  </files>
  <action>
    1. Add the following DTOs to `InsuranceXmlDTOs.cs`:

    ```csharp
    // XML6 - Mau va che pham mau (Blood and blood products)
    public class Xml6BloodDto
    {
        public string MaLk { get; set; } = string.Empty;
        public int Stt { get; set; }
        public string MaMau { get; set; } = string.Empty; // Blood product code
        public string TenMau { get; set; } = string.Empty;
        public decimal TheTich { get; set; } // Volume (ml)
        public decimal DonGia { get; set; }
        public decimal ThanhTien { get; set; }
        public decimal? TienBhyt { get; set; }
        public decimal? TienBnCct { get; set; }
        public decimal? TienNguoiBenh { get; set; }
        public DateTime? NgayYl { get; set; }
        public string? MaKhoa { get; set; }
        public string? MaBacSi { get; set; }
    }

    // XML8 - Van chuyen nguoi benh (Patient transport)
    public class Xml8TransportDto
    {
        public string MaLk { get; set; } = string.Empty;
        public int Stt { get; set; }
        public string PhuongTien { get; set; } = string.Empty; // Transport type
        public decimal KhoangCach { get; set; } // Distance (km)
        public decimal PhiVc { get; set; } // Transport fee
        public decimal? TienBhyt { get; set; }
        public DateTime? NgayVc { get; set; }
        public string? NoiDi { get; set; }
        public string? NoiDen { get; set; }
    }

    // XML9 - Giay nghi viec huong BHXH (Sick leave certificates)
    public class Xml9SickLeaveDto
    {
        public string MaLk { get; set; } = string.Empty;
        public int Stt { get; set; }
        public DateTime TuNgay { get; set; }
        public DateTime DenNgay { get; set; }
        public int SoNgay { get; set; }
        public string LyDo { get; set; } = string.Empty;
        public string? MaBenh { get; set; }
        public string? MaBacSi { get; set; }
    }

    // XML10 - Ket qua giam dinh (Assessment results)
    public class Xml10AssessmentDto
    {
        public string MaLk { get; set; } = string.Empty;
        public string KetQua { get; set; } = string.Empty; // Assessment result
        public string? GhiChu { get; set; }
        public DateTime NgayGiamDinh { get; set; }
        public string? MaNguoiGd { get; set; } // Assessor code
        public string? TenNguoiGd { get; set; }
    }

    // XML11 - So BHXH (Social insurance certificate)
    public class Xml11SocialInsuranceDto
    {
        public string MaLk { get; set; } = string.Empty;
        public string MaBhxh { get; set; } = string.Empty;
        public string HoTen { get; set; } = string.Empty;
        public string SoSoBhxh { get; set; } = string.Empty;
        public DateTime? NgaySinh { get; set; }
        public int? GioiTinh { get; set; }
    }

    // XML13 - Giay hen tai kham (Re-examination appointments) - QD 3176
    public class Xml13ReExamDto
    {
        public string MaLk { get; set; } = string.Empty;
        public int Stt { get; set; }
        public DateTime NgayHen { get; set; }
        public string NoiDung { get; set; } = string.Empty;
        public string? MaBacSi { get; set; }
        public string? MaKhoa { get; set; }
    }

    // XML14 - Phieu chuyen tuyen (Referral certificates) - QD 3176
    public class Xml14ReferralCertDto
    {
        public string MaLk { get; set; } = string.Empty;
        public int Stt { get; set; }
        public string SoPhieu { get; set; } = string.Empty;
        public string MaCskbChuyenDen { get; set; } = string.Empty;
        public string TenCskbChuyenDen { get; set; } = string.Empty;
        public DateTime NgayChuyen { get; set; }
        public string LyDoChuyen { get; set; } = string.Empty;
        public string? ChanDoanChuyen { get; set; }
        public string? HuongDieuTri { get; set; }
        public string? MaBacSi { get; set; }
    }

    // XML15 - Dieu tri lao (TB treatment details) - QD 3176
    public class Xml15TbTreatmentDto
    {
        public string MaLk { get; set; } = string.Empty;
        public int Stt { get; set; }
        public string PhacDo { get; set; } = string.Empty; // Treatment regimen
        public string GiaiDoan { get; set; } = string.Empty; // Treatment phase
        public DateTime? NgayBatDau { get; set; }
        public DateTime? NgayKetThuc { get; set; }
        public string? KetQua { get; set; }
    }
    ```

    2. Add generator method signatures to `IInsuranceXmlService.cs` in the "12.3 Xuat XML" region:
       - `Task<List<Xml6BloodDto>> GenerateXml6DataAsync(XmlExportConfigDto config);`
       - `Task<List<Xml8TransportDto>> GenerateXml8DataAsync(XmlExportConfigDto config);`
       - `Task<List<Xml9SickLeaveDto>> GenerateXml9DataAsync(XmlExportConfigDto config);`
       - `Task<List<Xml10AssessmentDto>> GenerateXml10DataAsync(XmlExportConfigDto config);`
       - `Task<List<Xml11SocialInsuranceDto>> GenerateXml11DataAsync(XmlExportConfigDto config);`
       - `Task<List<Xml13ReExamDto>> GenerateXml13DataAsync(XmlExportConfigDto config);`
       - `Task<List<Xml14ReferralCertDto>> GenerateXml14DataAsync(XmlExportConfigDto config);`
       - `Task<List<Xml15TbTreatmentDto>> GenerateXml15DataAsync(XmlExportConfigDto config);`

    3. Also update `XmlExportConfigDto` to include flags for new tables:
       - Add: `bool IncludeXml6`, `IncludeXml8`, `IncludeXml9`, `IncludeXml10`, `IncludeXml11`, `IncludeXml13`, `IncludeXml14`, `IncludeXml15` (all default true)

    4. Update `InsuranceXmlController.cs` to expose new XML table endpoints (following existing pattern):
       - POST `/api/insurance/xml/generate/xml6` through `/xml15`
  </action>
  <verify>
    cd backend/src/HIS.API && dotnet build --no-restore 2>&1 | tail -5
  </verify>
  <done>
    8 new XML table DTOs (XML6, XML8-XML11, XML13-XML15) defined with all BHXH-mandated fields. IInsuranceXmlService has 8 new generator method signatures. XmlExportConfigDto has include flags for all 15 tables. Controller exposes 8 new endpoints. Backend builds with 0 errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement all 15 XML table generators with real EF Core queries</name>
  <files>
    backend/src/HIS.Infrastructure/Services/InsuranceXmlService.cs
    backend/src/HIS.API/Controllers/InsuranceXmlController.cs
  </files>
  <action>
    All generators follow the same pattern: get InsuranceClaims for the export period (via existing `GetClaimsForExport` helper), then join with related HIS entities to extract the specific data needed for that XML table.

    Helper method (add if not exists):
    ```csharp
    private async Task<List<InsuranceClaim>> GetClaimsForExport(XmlExportConfigDto config)
    {
        var query = _context.InsuranceClaims
            .Include(c => c.Patient)
            .Include(c => c.MedicalRecord)
            .Include(c => c.ClaimDetails)
            .Where(c => !c.IsDeleted);

        if (config.FromDate.HasValue)
            query = query.Where(c => c.ServiceDate >= config.FromDate.Value);
        else
            query = query.Where(c => c.ServiceDate.Month == config.Month && c.ServiceDate.Year == config.Year);

        if (config.ToDate.HasValue)
            query = query.Where(c => c.ServiceDate <= config.ToDate.Value);

        if (config.DepartmentId.HasValue)
            query = query.Where(c => c.DepartmentId == config.DepartmentId.Value);

        return await query.AsNoTracking().ToListAsync();
    }
    ```

    1. **GenerateXml1DataAsync** - REWRITE existing partial implementation:
       - Join InsuranceClaims with Patient, MedicalRecord, Department
       - Fill ALL fields properly: MaKhoa from Department.DepartmentCode, MaPhong from exam room, SoNgayDt calculated from NgayVao/NgayRa, TinhTrangRv from discharge info, KetQuaDt from treatment result
       - Fill cost fields: TienKham, TienGiuong from ClaimDetails grouped by ItemType
       - Use `Math.Round(value, 2)` for all decimal amounts (per research pitfall #5)

    2. **GenerateXml2DataAsync** - Medicine treatment details:
       - Join InsuranceClaims → ClaimDetails (ItemType=2) → Medicine
       - Map: MaThuoc from Medicine.MedicineCode or InsurancePriceConfig.ItemCode, MaNhom from insurance group code, TenThuoc, DonViTinh, HamLuong, DuongDung from Medicine entity
       - SoLuong, DonGia, ThanhTien from ClaimDetail.Quantity/UnitPrice/Amount
       - TyLeThanhToan from InsuranceCoverage, TienBhyt/TienBnCct/TienNguoiBenh from ClaimDetail amounts
       - NgayYl from ServiceDate, MaBacSi from claim's DoctorId -> User.StaffCode

    3. **GenerateXml3DataAsync** - Technical services:
       - Join InsuranceClaims → ClaimDetails (ItemType=1) → Service
       - Map: MaDvu from Service.ServiceCode, MaNhom from service group, TenDvu, SoLuong/DonGia/ThanhTien
       - NgayYl from request date, NgayKq from result date (if lab/radiology)

    4. **GenerateXml4DataAsync** - Out-of-catalog medicines:
       - Join InsuranceClaims → ClaimDetails (ItemType=2, IsInsuranceCovered=false)
       - Same medicine fields as XML2 but without insurance payment columns

    5. **GenerateXml5DataAsync** - Prescriptions:
       - Query Prescriptions → PrescriptionDetails → Medicine for claims in period
       - Join with claim via MedicalRecordId
       - LieuDung from PrescriptionDetail.Dosage, SoNgay from PrescriptionDetail.DurationDays or calculated
       - NgayKeDon from Prescription.PrescriptionDate

    6. **GenerateXml6DataAsync** - Blood products:
       - Join InsuranceClaims → ClaimDetails where ItemType relates to blood (check if blood bank items exist)
       - If no blood data exists for the period, return empty list (not null)

    7. **GenerateXml7DataAsync** - REWRITE to use real referral data:
       - Query referral records (Discharge entities where discharge type = transfer/referral)
       - Map: SoHoSo, MaCskbChuyenDi (this facility), MaCskbChuyenDen, LyDoChuyenVien from referral reason

    8. **GenerateXml8DataAsync** - Patient transport:
       - Return empty list initially (transport records may not exist yet in HIS)
       - Log info "XML8: No transport records found for period"

    9. **GenerateXml9DataAsync** - Sick leave certificates:
       - Return empty list initially (sick leave tracking may not be implemented)
       - Structure ready for when sick leave module is added

    10. **GenerateXml10DataAsync** - Assessment results:
        - Return empty list (assessment results come from BHXH feedback, not generated locally)

    11. **GenerateXml11DataAsync** - Social insurance certificates:
        - Join InsuranceClaims → Patient
        - Map patient's social insurance number if available

    12. **GenerateXml13DataAsync** - Re-examination appointments:
        - Query Appointments table for follow-up appointments linked to claims in period
        - Map NgayHen, NoiDung from appointment notes

    13. **GenerateXml14DataAsync** - Referral certificates (similar to XML7 but per QD 3176 format):
        - Query same referral data as XML7, different field mapping

    14. **GenerateXml15DataAsync** - TB treatment:
        - Return empty list (TB treatment tracking is specialized)

    Important rules for ALL generators:
    - Use `AsNoTracking()` for read-only queries (performance)
    - Use `Math.Round(amount, 2)` for all money fields
    - Never return null -- return empty `List<T>()` for empty tables
    - STT (sequence number) starts at 1, incremented per record within each MaLk group
    - Date fields use DateTime (will be formatted to `yyyyMMddHHmm` at XML generation stage in Plan 03)
  </action>
  <verify>
    cd backend/src/HIS.API && dotnet build --no-restore 2>&1 | tail -5
    Then test XML1 data generation:
    curl -s -X POST http://localhost:5106/api/auth/login -H "Content-Type: application/json" -d '{"username":"admin","password":"Admin@123"}' | jq -r '.token' > /tmp/token.txt 2>/dev/null && curl -s -X POST http://localhost:5106/api/insurance/xml/generate/xml1 -H "Authorization: Bearer $(cat /tmp/token.txt)" -H "Content-Type: application/json" -d '{"month":2,"year":2026,"includeXml1":true,"includeXml2":true,"includeXml3":true,"includeXml4":true,"includeXml5":true,"includeXml7":true,"validateBeforeExport":false,"compressOutput":false}' | head -c 500
  </verify>
  <done>
    All 15 XML table generators implemented with real EF Core queries. XML1 returns full patient/claim records. XML2 returns real medicine data from ClaimDetails. XML3 returns real service data. XML4 filters non-covered medicines. XML5 extracts prescription details. XML6-XML15 implemented (some return empty lists when no data exists for that category, which is correct behavior). All money fields rounded to 2 decimals. All generators return empty lists (not null) for empty tables. Backend builds with 0 errors.
  </done>
</task>

</tasks>

<verification>
1. Backend builds with 0 errors: `cd backend/src/HIS.API && dotnet build`
2. All 15 XML table generator methods exist in InsuranceXmlService
3. GenerateXml1DataAsync returns records with real patient data (not empty strings for MaKhoa, MaPhong)
4. GenerateXml2DataAsync returns medicine data linked to insurance claims
5. New XML table endpoints (xml6, xml8-xml15) respond with 200
6. No generator method returns null (all return empty list if no data)
</verification>

<success_criteria>
- 8 new XML table DTOs defined (XML6, XML8-XML11, XML13-XML15)
- All 15 GenerateXmlNDataAsync methods implemented with real EF Core queries
- XML1 fully rewritten with proper Department/Room/Cost joins
- XML2-XML5 rewritten to query from ClaimDetails + related entities
- XML7 rewritten to use real referral/discharge data
- New XML8-XML15 generators implemented (empty list for tables without HIS data yet)
- All monetary amounts rounded to 2 decimal places
- Backend compiles with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-bhxh-gateway-xml4210/01-02-SUMMARY.md`
</output>
