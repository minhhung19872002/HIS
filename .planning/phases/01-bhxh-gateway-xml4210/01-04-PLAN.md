---
phase: 01-bhxh-gateway-xml4210
plan: 04
type: execute
wave: 2
depends_on: [01-01]
files_modified:
  - frontend/src/pages/Insurance.tsx
  - frontend/src/pages/Reception.tsx
  - frontend/src/api/insurance.ts
  - frontend/cypress/e2e/bhxh-insurance.cy.ts
autonomous: true
requirements: [XML-04]

must_haves:
  truths:
    - "Insurance page has a batch export tab with preview-then-generate workflow"
    - "Reception page shows insurance verification result after card check"
    - "XML signing button calls existing DigitalSignatureService on generated XML files"
    - "Export preview displays record counts per table, total costs, and blocking errors"
    - "Staff can download generated XML files after export"
    - "Cypress tests verify insurance verification flow and XML export UI"
  artifacts:
    - path: "frontend/src/pages/Insurance.tsx"
      provides: "Enhanced Insurance page with batch export workflow"
      min_lines: 300
    - path: "frontend/src/pages/Reception.tsx"
      provides: "Insurance verification integration in registration"
    - path: "frontend/src/api/insurance.ts"
      provides: "New API functions for preview and signing"
    - path: "frontend/cypress/e2e/bhxh-insurance.cy.ts"
      provides: "Cypress E2E tests for BHXH integration features"
      min_lines: 50
  key_links:
    - from: "frontend/src/pages/Insurance.tsx"
      to: "/api/insurance/xml/preview"
      via: "fetch before export"
      pattern: "previewExport"
    - from: "frontend/src/pages/Insurance.tsx"
      to: "/api/insurance/xml/export"
      via: "fetch after user confirms preview"
      pattern: "exportXml"
    - from: "frontend/src/pages/Reception.tsx"
      to: "/api/insurance/verify-card"
      via: "fetch on insurance number blur/button click"
      pattern: "verifyInsuranceCard"
---

<objective>
Enhance the frontend Insurance page with batch XML export workflow (preview-then-generate per locked decision), add insurance verification to the Reception page, implement XML signing integration, and create comprehensive Cypress tests.

Purpose: The backend is wired up (Plans 01-03), but the frontend still shows static data on the Insurance page and the Reception page has no insurance verification integration. This plan connects the frontend to the real backend services and adds the batch export UX that staff will use daily.

Output: Working Insurance page with batch export, Reception with card verification, Cypress tests
</objective>

<execution_context>
@C:/Users/ADMIN/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ADMIN/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-bhxh-gateway-xml4210/01-RESEARCH.md
@.planning/phases/01-bhxh-gateway-xml4210/01-01-SUMMARY.md

<interfaces>
<!-- Frontend API client already exists -->
From frontend/src/api/insurance.ts:
```typescript
export const verifyInsuranceCard = (data: { insuranceNumber: string; patientName: string; dateOfBirth: string }) =>
  request.post<InsuranceCardVerificationDto>('/insurance/verify-card', data);
export const getInsuranceHistory = (insuranceNumber: string) =>
  request.get<InsuranceHistoryDto>(`/insurance/history/${insuranceNumber}`);
export const exportXml = (config: XmlExportConfigDto) =>
  request.post<XmlExportResultDto>('/insurance/xml/export', config);
export const downloadXmlFile = (batchId: string) =>
  request.get(`/insurance/xml/download/${batchId}`, { responseType: 'blob' });
export const validateBeforeExport = (config: XmlExportConfigDto) =>
  request.post<InsuranceValidationResultDto[]>('/insurance/validate/before-export', config);
```

<!-- New endpoints from Plan 03 that need frontend API functions -->
- POST /api/insurance/xml/preview -> XmlExportPreviewDto
- POST /api/insurance/xml/sign/{batchId} -> SignResultDto (uses DigitalSignatureService)

<!-- Existing Reception page at frontend/src/pages/Reception.tsx -->
<!-- Existing Insurance page at frontend/src/pages/Insurance.tsx -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add new API functions and enhance Insurance.tsx with batch export workflow</name>
  <files>
    frontend/src/api/insurance.ts
    frontend/src/pages/Insurance.tsx
  </files>
  <action>
    1. Add new API functions to `frontend/src/api/insurance.ts`:
       ```typescript
       // Preview export before generating
       export const previewExport = (config: XmlExportConfigDto) =>
         request.post<XmlExportPreviewDto>('/insurance/xml/preview', config);

       // Sign XML batch with digital signature
       export const signXmlBatch = (batchId: string) =>
         request.post<{ success: boolean; message: string }>(`/insurance/xml/sign/${batchId}`);
       ```

       Add new TypeScript interfaces:
       ```typescript
       export interface XmlExportPreviewDto {
         totalRecords: number;
         dateRangeFrom?: string;
         dateRangeTo?: string;
         departmentName?: string;
         totalCostAmount: number;
         totalInsuranceAmount: number;
         totalPatientAmount: number;
         tables: XmlTablePreview[];
         validationErrors: InsuranceValidationResultDto[];
         hasBlockingErrors: boolean;
       }

       export interface XmlTablePreview {
         tableName: string;
         description: string;
         recordCount: number;
       }
       ```

    2. Enhance `Insurance.tsx` -- add or improve the "Xuat XML" (XML Export) tab:

       The tab should have this workflow (per locked decisions):

       **Step 1 - Configure export:**
       - DatePicker.RangePicker for date range (default: current month)
       - Select department filter (optional, loads from API)
       - Filter by date range + department only (per locked decision -- NO status filter, patient type filter, or individual patient selection)
       - Button: "Xem truoc" (Preview)

       **Step 2 - Preview results (shown after clicking Preview):**
       - Summary cards: Total records, Total cost (VND), Insurance amount, Patient amount
       - Table listing all 15 XML tables with record counts (Antd Table):
         | Bang | Mo ta | So ban ghi |
         | XML1 | Thong tin chung ho so KCB | 150 |
         | XML2 | Chi tiet thuoc | 1,240 |
         | ... etc |
       - If `hasBlockingErrors === true`:
         - Show Alert type="error" title="Du lieu chua day du - Khong the xuat XML"
         - Show validation errors table: MaLk, ErrorCode, Error message (per locked decision: checklist of missing required fields with record references)
         - Export button is DISABLED
       - If no blocking errors:
         - Show Alert type="success" title="Du lieu hop le - San sang xuat XML"
         - Button: "Xac nhan xuat XML" (Confirm Export) -- enabled

       **Step 3 - Export (after clicking Confirm):**
       - Call `exportXml(config)` API
       - Show Spin loading during export
       - On success:
         - Show success message with batch code
         - Show "Tai XML" (Download) button
         - Show "Ky so XML" (Sign XML) button (calls signXmlBatch)
       - On error:
         - Show error details from response

       **Step 4 - Sign (optional):**
       - Button "Ky so XML" calls `signXmlBatch(batchId)`
       - Show result (success/failure message)

       UI patterns (matching existing Antd v6 patterns in this project):
       - Use `Spin` wrapper for loading states
       - Use `message.warning` for API errors (per project convention -- not console.error)
       - Use `Statistic` components for summary cards (use `styles={{ content: {...} }}` not `valueStyle` per Antd v6)
       - Use `Alert` with `title` prop (not `message` -- Antd v6 convention per CLAUDE.md)
       - Use `Space orientation="vertical"` (not `direction` -- Antd v6 per CLAUDE.md)
       - Format VND amounts: `new Intl.NumberFormat('vi-VN').format(amount)` + " VND"

    3. Also ensure the existing "Tra cuu the" (Card Verification) section on the Insurance page properly calls `verifyInsuranceCard` and displays the result in a Descriptions component showing all card details (MaThe, HoTen, NgaySinh, GtTheTu, GtTheDen, MucHuong, DuDkKcb, MaDkbd, etc.)
  </action>
  <verify>
    cd frontend && npx tsc --noEmit 2>&1 | tail -5
    cd frontend && npx vite build 2>&1 | tail -3
  </verify>
  <done>
    Insurance page has working batch export workflow: configure filters -> preview with table counts and blocking errors -> confirm export -> download/sign. Card verification section displays full card details from API. All new API functions typed. TypeScript compiles with 0 errors. Vite build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add insurance verification to Reception page and create Cypress tests</name>
  <files>
    frontend/src/pages/Reception.tsx
    frontend/cypress/e2e/bhxh-insurance.cy.ts
  </files>
  <action>
    1. Enhance `Reception.tsx` with insurance verification:
       - Find the patient registration form/modal (the one with insurance number field)
       - After user enters insurance number (on blur or via a "Xac minh" button next to the field):
         - Call `verifyInsuranceCard({ insuranceNumber, patientName, dateOfBirth })`
         - Show a result panel below the insurance number field:
           - If DuDkKcb=true (valid): green Tag "Du dieu kien KCB", show coverage rate (MucHuong%), card validity period
           - If DuDkKcb=false (invalid): red Tag "Khong du dieu kien", show LyDoKhongDuDk reason
           - If gateway error: yellow Tag "Khong ket noi duoc cong BHXH", allow manual entry (per BHXH-05 graceful degradation)
       - Store verification result in form state so it can be submitted with patient registration
       - Do NOT block registration on verification failure (per research anti-pattern -- verification is informational)

    2. Add a small insurance history lookup:
       - After successful verification, show a link/button "Xem lich su KCB"
       - On click: call `getInsuranceHistory(insuranceNumber)`
       - Show history in a small Modal/Drawer with table: Ngay KCB, Ten CSKCB, Ma benh chinh, Tien BHYT

    3. Create `frontend/cypress/e2e/bhxh-insurance.cy.ts` with tests:

       ```typescript
       describe('BHXH Insurance Integration', () => {
         beforeEach(() => {
           // Login as admin
           cy.request('POST', 'http://localhost:5106/api/auth/login', {
             username: 'admin', password: 'Admin@123'
           }).then(res => {
             localStorage.setItem('token', res.body.token);
             localStorage.setItem('user', JSON.stringify(res.body));
           });
         });

         describe('Insurance Card Verification API', () => {
           it('should verify insurance card via API', () => {
             cy.request({
               method: 'POST',
               url: 'http://localhost:5106/api/insurance/verify-card',
               headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
               body: { insuranceNumber: 'DN4950100234567', patientName: 'Nguyen Van A', dateOfBirth: '1990-01-15' }
             }).then(res => {
               expect(res.status).to.eq(200);
               expect(res.body).to.have.property('maThe');
               expect(res.body).to.have.property('duDkKcb');
               expect(res.body).to.have.property('mucHuong');
             });
           });

           it('should retrieve insurance history via API', () => {
             cy.request({
               method: 'GET',
               url: 'http://localhost:5106/api/insurance/history/DN4950100234567',
               headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
             }).then(res => {
               expect(res.status).to.eq(200);
               expect(res.body).to.have.property('maThe');
               expect(res.body).to.have.property('visits');
             });
           });

           it('should test portal connection', () => {
             cy.request({
               method: 'GET',
               url: 'http://localhost:5106/api/insurance/config/test-connection',
               headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
             }).then(res => {
               expect(res.status).to.eq(200);
               expect(res.body).to.have.property('isConnected');
             });
           });
         });

         describe('Insurance Page - XML Export', () => {
           it('should load insurance page at /insurance', () => {
             cy.visit('/insurance');
             cy.contains('BHYT').should('be.visible');
           });

           it('should have XML export tab', () => {
             cy.visit('/insurance');
             // Find and click the XML export tab
             cy.contains(/xu.{0,2}t.*xml/i).click({ force: true });
           });

           it('should show export preview with table counts', () => {
             cy.visit('/insurance');
             cy.contains(/xu.{0,2}t.*xml/i).click({ force: true });
             // Click preview button
             cy.contains(/xem.*tr..c|preview/i).should('be.visible');
           });

           it('should have card verification section', () => {
             cy.visit('/insurance');
             cy.contains(/tra.*c.{0,2}u|xac.*minh|verify/i).should('be.visible');
           });
         });

         describe('Reception Page - Insurance Verification', () => {
           it('should load reception page', () => {
             cy.visit('/reception');
             cy.get('.ant-spin-spinning', { timeout: 10000 }).should('not.exist');
           });

           it('should have insurance number field in registration', () => {
             cy.visit('/reception');
             // Open registration modal
             cy.contains(/dang.*ky|tiep.*don/i).first().click({ force: true });
             // Look for insurance number field
             cy.get('input[placeholder*="BHYT"], input[placeholder*="bao hiem"], label:contains("BHYT")').should('exist');
           });
         });

         describe('XML Export API', () => {
           it('should preview XML export', () => {
             cy.request({
               method: 'POST',
               url: 'http://localhost:5106/api/insurance/xml/preview',
               headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
               body: { month: 2, year: 2026, validateBeforeExport: true,
                 includeXml1: true, includeXml2: true, includeXml3: true,
                 includeXml4: true, includeXml5: true, includeXml7: true,
                 compressOutput: false }
             }).then(res => {
               expect(res.status).to.eq(200);
               expect(res.body).to.have.property('totalRecords');
               expect(res.body).to.have.property('tables');
               expect(res.body.tables).to.be.an('array');
             });
           });

           it('should export XML files', () => {
             cy.request({
               method: 'POST',
               url: 'http://localhost:5106/api/insurance/xml/export',
               headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
               body: { month: 2, year: 2026, validateBeforeExport: false,
                 includeXml1: true, includeXml2: true, includeXml3: true,
                 includeXml4: true, includeXml5: true, includeXml7: true,
                 compressOutput: false }
             }).then(res => {
               expect(res.status).to.eq(200);
               expect(res.body).to.have.property('batchId');
               expect(res.body).to.have.property('batchCode');
               expect(res.body).to.have.property('totalRecords');
             });
           });
         });
       });
       ```

    4. Add the Insurance page to `console-errors.cy.ts` pages list (if not already there -- verify first). Also add any new pages.

    5. Ensure console-errors pass for Insurance page:
       - If any API calls in Insurance.tsx fail during page load, use `message.warning` not `console.error`
       - Add SignalR connection errors to IGNORE_PATTERNS if needed (already done in project)
  </action>
  <verify>
    cd frontend && npx tsc --noEmit 2>&1 | tail -5
    cd frontend && npx cypress run --spec "cypress/e2e/bhxh-insurance.cy.ts" --browser chrome 2>&1 | tail -20
  </verify>
  <done>
    Reception page shows insurance verification result (green/red/yellow status) after checking insurance number. Card details displayed inline. History lookup available via modal. Insurance page XML export tab has full preview-then-generate workflow. Cypress tests verify: API card verification, API history lookup, API portal test, API XML preview, API XML export, Insurance page loads, Reception page has insurance field. All tests pass. console-errors test passes for Insurance page.
  </done>
</task>

</tasks>

<verification>
1. TypeScript: 0 errors (`cd frontend && npx tsc --noEmit`)
2. Vite build: success (`cd frontend && npx vite build`)
3. Cypress bhxh-insurance tests: all pass
4. Console-errors tests: all pass (including Insurance page)
5. Insurance page loads with XML export tab showing preview workflow
6. Reception page shows insurance verification result after card check
7. Gateway error handling: yellow warning shown, registration not blocked
</verification>

<success_criteria>
- Insurance page has batch export tab: date range + department filter, preview with table counts, confirm export, download, sign
- Preview shows blocking errors with MaLk references when data is incomplete
- Export is blocked when required fields are missing (per locked decision)
- Reception page shows insurance card verification result inline
- Treatment history viewable in modal from Reception
- Gateway failures show warning, don't block registration
- Cypress tests pass: API verification, XML export, UI interactions
- 0 TypeScript errors, Vite build success
</success_criteria>

<output>
After completion, create `.planning/phases/01-bhxh-gateway-xml4210/01-04-SUMMARY.md`
</output>
