---
phase: 01-bhxh-gateway-xml4210
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/HIS.Application/Services/IBhxhGatewayClient.cs
  - backend/src/HIS.Application/DTOs/Insurance/BhxhGatewayDTOs.cs
  - backend/src/HIS.Application/DTOs/Insurance/InsuranceXmlDTOs.cs
  - backend/src/HIS.Infrastructure/Services/BhxhGatewayClient.cs
  - backend/src/HIS.Infrastructure/Services/BhxhGatewayMockClient.cs
  - backend/src/HIS.Infrastructure/Configuration/BhxhGatewayOptions.cs
  - backend/src/HIS.Infrastructure/DependencyInjection.cs
  - backend/src/HIS.Infrastructure/Services/InsuranceXmlService.cs
  - backend/src/HIS.API/appsettings.json
autonomous: true
requirements: [BHXH-01, BHXH-02, BHXH-03, BHXH-04, BHXH-05]

must_haves:
  truths:
    - "Insurance card verification calls IBhxhGatewayClient instead of returning hardcoded mock data"
    - "Treatment history lookup delegates to IBhxhGatewayClient with OTP parameter support"
    - "Cost submission delegates to IBhxhGatewayClient and returns a real transaction ID"
    - "Assessment result retrieval delegates to IBhxhGatewayClient with polling pattern"
    - "Gateway failures are handled with retry, circuit breaker, and graceful degradation showing cached data"
    - "Mock client provides realistic development data so frontend can be tested without real BHXH credentials"
  artifacts:
    - path: "backend/src/HIS.Application/Services/IBhxhGatewayClient.cs"
      provides: "Abstraction for BHXH gateway API calls"
      exports: ["IBhxhGatewayClient"]
    - path: "backend/src/HIS.Infrastructure/Services/BhxhGatewayClient.cs"
      provides: "Real HTTP implementation with token management"
      min_lines: 100
    - path: "backend/src/HIS.Infrastructure/Services/BhxhGatewayMockClient.cs"
      provides: "Mock implementation for development/testing"
      min_lines: 80
    - path: "backend/src/HIS.Infrastructure/Configuration/BhxhGatewayOptions.cs"
      provides: "Configuration POCO for appsettings.json"
      exports: ["BhxhGatewayOptions"]
    - path: "backend/src/HIS.Application/DTOs/Insurance/BhxhGatewayDTOs.cs"
      provides: "Request/response DTOs for gateway communication"
      min_lines: 50
  key_links:
    - from: "backend/src/HIS.Infrastructure/Services/InsuranceXmlService.cs"
      to: "IBhxhGatewayClient"
      via: "constructor injection"
      pattern: "IBhxhGatewayClient"
    - from: "backend/src/HIS.Infrastructure/DependencyInjection.cs"
      to: "BhxhGatewayClient or BhxhGatewayMockClient"
      via: "conditional registration based on BhxhGatewayOptions.UseMock"
      pattern: "AddHttpClient.*IBhxhGatewayClient"
---

<objective>
Create the BHXH Gateway client abstraction layer and wire it into the existing InsuranceXmlService, replacing all mock/hardcoded gateway responses with delegated calls through IBhxhGatewayClient.

Purpose: This is the foundation for all BHXH integration. The abstraction allows development to proceed with a mock client while the hospital obtains real credentials from their provincial BHXH office. The real client will work once credentials are configured in appsettings.json.

Output: IBhxhGatewayClient interface + real HTTP client + mock client + configuration + InsuranceXmlService rewired
</objective>

<execution_context>
@C:/Users/ADMIN/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ADMIN/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-bhxh-gateway-xml4210/01-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs -->

From backend/src/HIS.Application/Services/IInsuranceXmlService.cs:
```csharp
// Section 12.1 - These methods currently return hardcoded mock data:
Task<InsuranceCardVerificationDto> VerifyInsuranceCardAsync(string insuranceNumber, string patientName, DateTime dateOfBirth);
Task<InsuranceHistoryDto> GetInsuranceHistoryAsync(string insuranceNumber);
Task<bool> CheckInsuranceValidityAsync(string insuranceNumber, DateTime serviceDate);
Task<InsuranceBenefitDto> GetInsuranceBenefitsAsync(string insuranceNumber);
Task<bool> CheckPrimaryRegistrationAsync(string insuranceNumber, string facilityCode);

// Section 12.5 - These methods return stub responses:
Task<SubmitResultDto> SubmitToInsurancePortalAsync(SubmitToInsurancePortalDto dto);
Task<SubmitStatusDto> CheckSubmitStatusAsync(string transactionId);
Task<InsuranceFeedbackDto> GetInsuranceFeedbackAsync(string transactionId);
Task<SubmitResultDto> ResubmitRejectedClaimsAsync(List<string> maLkList);
```

From backend/src/HIS.Application/DTOs/Insurance/InsuranceXmlDTOs.cs:
```csharp
public class InsuranceCardVerificationDto { /* full DTO with MaThe, HoTen, NgaySinh, etc. */ }
public class InsuranceHistoryDto { string MaThe; List<InsuranceVisitHistoryDto> Visits; }
public class SubmitToInsurancePortalDto { Guid BatchId; string Username; string Password; string CertificatePath; bool TestMode; }
public class SubmitResultDto { bool Success; string? TransactionId; string? Message; List<SubmitError> Errors; DateTime SubmitTime; }
```

From backend/src/HIS.Infrastructure/Services/DigitalSignatureService.cs:
```csharp
// Existing signing service - will be used in Plan 04 for XML signing
public class DigitalSignatureService { Task<byte[]> SignDataAsync(byte[] data); }
```

From backend/src/HIS.Infrastructure/DependencyInjection.cs:
```csharp
// All services registered here. New gateway client registration goes here too.
services.AddScoped<IInsuranceXmlService, InsuranceXmlService>();
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IBhxhGatewayClient interface, DTOs, configuration, and both client implementations</name>
  <files>
    backend/src/HIS.Application/Services/IBhxhGatewayClient.cs
    backend/src/HIS.Application/DTOs/Insurance/BhxhGatewayDTOs.cs
    backend/src/HIS.Infrastructure/Configuration/BhxhGatewayOptions.cs
    backend/src/HIS.Infrastructure/Services/BhxhGatewayClient.cs
    backend/src/HIS.Infrastructure/Services/BhxhGatewayMockClient.cs
    backend/src/HIS.Infrastructure/DependencyInjection.cs
    backend/src/HIS.API/appsettings.json
  </files>
  <action>
    1. Create `IBhxhGatewayClient.cs` in HIS.Application/Services with these methods:
       - `Task<BhxhTokenResponse> GetTokenAsync(CancellationToken ct = default)` - authenticate with BHXH portal
       - `Task<BhxhCardVerifyResponse> VerifyCardAsync(BhxhCardVerifyRequest request, CancellationToken ct = default)` - real-time card check
       - `Task<BhxhTreatmentHistoryResponse> GetTreatmentHistoryAsync(BhxhTreatmentHistoryRequest request, CancellationToken ct = default)` - requires OTP
       - `Task<BhxhSubmitResponse> SubmitCostDataAsync(BhxhSubmitRequest request, CancellationToken ct = default)` - submit XML data
       - `Task<BhxhAssessmentResponse> GetAssessmentResultAsync(string transactionId, CancellationToken ct = default)` - get assessment
       - `Task<bool> TestConnectionAsync(CancellationToken ct = default)` - connectivity check
       - `Task<BhxhCheckInResponse> CheckInPatientAsync(BhxhCheckInRequest request, CancellationToken ct = default)` - real-time check-in

    2. Create `BhxhGatewayDTOs.cs` in HIS.Application/DTOs/Insurance with request/response DTOs:
       - `BhxhTokenResponse` (Token, ExpiresAt)
       - `BhxhCardVerifyRequest` (MaThe, HoTen, NgaySinh, MaCsKcb)
       - `BhxhCardVerifyResponse` (all fields from InsuranceCardVerificationDto + raw gateway fields)
       - `BhxhTreatmentHistoryRequest` (MaThe, Otp, FromDate, ToDate)
       - `BhxhTreatmentHistoryResponse` (List of visit records)
       - `BhxhSubmitRequest` (XmlBase64, BatchCode, FacilityCode)
       - `BhxhSubmitResponse` (TransactionId, Message, Status)
       - `BhxhAssessmentResponse` (TransactionId, Status, TotalRecords, AcceptedRecords, RejectedRecords, Items)
       - `BhxhCheckInRequest` (MaThe, HoTen, NgaySinh, MaCsKcb, NgayVao)
       - `BhxhCheckInResponse` (MaLk generated, Status)
       - Use BHXH date format helper: `yyyyMMddHHmm` via CultureInfo.InvariantCulture

    3. Create `BhxhGatewayOptions.cs` in HIS.Infrastructure/Configuration:
       ```csharp
       public class BhxhGatewayOptions
       {
           public const string SectionName = "BhxhGateway";
           public string BaseUrl { get; set; } = "https://gdbhyt.baohiemxahoi.gov.vn";
           public string Username { get; set; } = "";
           public string Password { get; set; } = "";
           public string FacilityCode { get; set; } = ""; // Ma CSKCB
           public int TimeoutSeconds { get; set; } = 30;
           public bool UseMock { get; set; } = true; // Default to mock
           public int RetryCount { get; set; } = 3;
           public int CircuitBreakerThreshold { get; set; } = 5;
           public int CircuitBreakerDurationSeconds { get; set; } = 30;
       }
       ```

    4. Create `BhxhGatewayClient.cs` (real HTTP client):
       - Inject HttpClient (from IHttpClientFactory) + IOptions<BhxhGatewayOptions> + ILogger
       - Implement token management: cache token, check expiry, refresh when < 5 min remaining
       - All methods: EnsureTokenAsync() first, then make HTTP call with Bearer token
       - Use System.Text.Json for serialization with camelCase property naming
       - VerifyCardAsync: POST to `/api/egw/nhanHoSo` with BHXH field names (maThe, hoTen, ngaySinh, maCsKcb)
       - GetTreatmentHistoryAsync: POST to `/api/egw/lichSuKcb` with OTP field
       - SubmitCostDataAsync: POST to `/api/egw/guiHoSo` with base64 XML + batch code
       - GetAssessmentResultAsync: GET to `/api/egw/ketQuaGiamDinh/{transactionId}`
       - CheckInPatientAsync: POST to `/api/egw/checkIn`
       - TestConnectionAsync: try GetTokenAsync, return success/failure
       - Log all gateway calls and responses at Debug level, errors at Warning level

    5. Create `BhxhGatewayMockClient.cs` (development mock):
       - No HTTP calls -- return realistic Vietnamese data immediately
       - VerifyCardAsync: return valid card with Vietnamese names, realistic dates, MucHuong "80", LoaiThe "DN", DuDkKcb=true. Recognize special insurance numbers for edge cases: "*INVALID*" returns DuDkKcb=false, "*EXPIRED*" returns expired dates
       - GetTreatmentHistoryAsync: return 3-5 mock visit records at realistic Vietnamese hospitals
       - SubmitCostDataAsync: return success with generated transaction ID
       - GetAssessmentResultAsync: return 80% accepted, 20% rejected with realistic reject codes
       - TestConnectionAsync: return true with 50ms simulated delay
       - GetTokenAsync: return mock token with 1-hour expiry

    6. Add to `DependencyInjection.cs`:
       - `services.Configure<BhxhGatewayOptions>(configuration.GetSection(BhxhGatewayOptions.SectionName));`
       - Conditional registration: if `BhxhGatewayOptions.UseMock == true`, register `BhxhGatewayMockClient` as `IBhxhGatewayClient`
       - Otherwise, register `BhxhGatewayClient` via `AddHttpClient<IBhxhGatewayClient, BhxhGatewayClient>()` with Polly retry (exponential backoff 3 retries) and circuit breaker (threshold 5, duration 30s)
       - Install `Microsoft.Extensions.Http.Polly` package: `cd backend/src/HIS.Infrastructure && dotnet add package Microsoft.Extensions.Http.Polly --version 9.0.0`

    7. Add `BhxhGateway` section to `appsettings.json`:
       ```json
       "BhxhGateway": {
         "BaseUrl": "https://gdbhyt.baohiemxahoi.gov.vn",
         "Username": "",
         "Password": "",
         "FacilityCode": "",
         "TimeoutSeconds": 30,
         "UseMock": true,
         "RetryCount": 3,
         "CircuitBreakerThreshold": 5,
         "CircuitBreakerDurationSeconds": 30
       }
       ```
  </action>
  <verify>
    cd backend/src/HIS.Infrastructure && dotnet build --no-restore 2>&1 | tail -5
    If build errors, check that Microsoft.Extensions.Http.Polly is installed and all DTOs match interface signatures.
  </verify>
  <done>
    IBhxhGatewayClient interface exists with 7 methods. BhxhGatewayClient implements real HTTP with token management. BhxhGatewayMockClient returns realistic Vietnamese test data. BhxhGatewayOptions configured in appsettings.json with UseMock=true. DI registration conditional on UseMock flag. Polly retry + circuit breaker configured for real client. Backend builds with 0 errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewire InsuranceXmlService to use IBhxhGatewayClient for all gateway operations</name>
  <files>
    backend/src/HIS.Infrastructure/Services/InsuranceXmlService.cs
  </files>
  <action>
    1. Add `IBhxhGatewayClient _gatewayClient` to InsuranceXmlService constructor. Add `ILogger<InsuranceXmlService> _logger`.

    2. Rewrite `VerifyInsuranceCardAsync` (section 12.1):
       - Create BhxhCardVerifyRequest from parameters
       - Call `_gatewayClient.VerifyCardAsync(request)`
       - Map BhxhCardVerifyResponse to existing InsuranceCardVerificationDto
       - Wrap in try/catch: on gateway failure, log warning, return a dto with DuDkKcb=false and LyDoKhongDuDk="Khong the ket noi cong BHXH. Vui long thu lai sau." (per BHXH-05)
       - Do NOT block patient registration on gateway failure (per research anti-pattern)

    3. Rewrite `GetInsuranceHistoryAsync` (section 12.1):
       - Call `_gatewayClient.GetTreatmentHistoryAsync(request)` -- note OTP is required; pass empty OTP for now (frontend will send OTP in a future enhancement, or we add an OTP parameter)
       - Actually: add an optional `string? otp = null` parameter to the interface method `GetInsuranceHistoryAsync`. Update IInsuranceXmlService to match: `Task<InsuranceHistoryDto> GetInsuranceHistoryAsync(string insuranceNumber, string? otp = null)`
       - Map response to InsuranceHistoryDto
       - On failure: return empty history with a warning log

    4. Rewrite `CheckInsuranceValidityAsync` (section 12.1):
       - Call VerifyCardAsync, check GtTheTu <= serviceDate <= GtTheDen and DuDkKcb=true
       - On gateway failure: return true with warning log (don't block workflow)

    5. Rewrite `GetInsuranceBenefitsAsync` (section 12.1):
       - Call VerifyCardAsync, extract coverage info into InsuranceBenefitDto
       - PaymentRatio from MucHuong, Is5YearsContinuous from NgayDu5Nam, etc.

    6. Rewrite `CheckPrimaryRegistrationAsync` (section 12.1):
       - Call VerifyCardAsync, compare MaDkbd with facilityCode
       - Return true if match, false otherwise

    7. Rewrite `SubmitToInsurancePortalAsync` (section 12.5):
       - Call `_gatewayClient.SubmitCostDataAsync(request)` with XML base64 from the batch
       - Map response to SubmitResultDto
       - On failure: return Success=false with error message

    8. Rewrite `CheckSubmitStatusAsync` (section 12.5):
       - Call `_gatewayClient.GetAssessmentResultAsync(transactionId)`
       - Map to SubmitStatusDto (Status: 0=processing, 1=success, 2=error)

    9. Rewrite `GetInsuranceFeedbackAsync` (section 12.5):
       - Call `_gatewayClient.GetAssessmentResultAsync(transactionId)`
       - Map to InsuranceFeedbackDto with individual item acceptance/rejection

    10. Rewrite `ResubmitRejectedClaimsAsync` (section 12.5):
       - For each maLk, regenerate XML data, re-submit via gateway
       - Return aggregated result

    11. Keep `TestPortalConnectionAsync` (section 12.9) - call `_gatewayClient.TestConnectionAsync()`

    12. Update InsuranceXmlService constructor in DependencyInjection.cs if needed (should be automatic via DI since IBhxhGatewayClient is registered).
  </action>
  <verify>
    cd backend/src/HIS.API && dotnet build --no-restore 2>&1 | tail -5
    Then run: curl -s -X POST http://localhost:5106/api/auth/login -H "Content-Type: application/json" -d '{"username":"admin","password":"Admin@123"}' | jq -r '.token' > /tmp/token.txt 2>/dev/null && curl -s -X POST http://localhost:5106/api/insurance/verify-card -H "Authorization: Bearer $(cat /tmp/token.txt)" -H "Content-Type: application/json" -d '{"insuranceNumber":"DN4950100234567","patientName":"Nguyen Van A","dateOfBirth":"1990-01-15"}' | head -c 200
  </verify>
  <done>
    All 10 gateway-dependent methods in InsuranceXmlService now delegate to IBhxhGatewayClient. Mock client returns realistic Vietnamese data. Gateway failures are caught with graceful degradation (warning log + fallback response). No method returns hardcoded "simulated verification" data anymore. Backend builds and verify-card endpoint returns mock data successfully.
  </done>
</task>

</tasks>

<verification>
1. Backend builds with 0 errors: `cd backend/src/HIS.API && dotnet build`
2. Insurance verify-card endpoint returns realistic mock data (not hardcoded "BV Da khoa")
3. Insurance history endpoint returns mock visit history (not empty list)
4. Portal test-connection endpoint returns connected=true
5. appsettings.json has BhxhGateway section with UseMock=true
</verification>

<success_criteria>
- IBhxhGatewayClient interface with 7 methods created
- Real HTTP client with token management and Polly resilience
- Mock client with realistic Vietnamese test data
- Configuration POCO in appsettings.json
- InsuranceXmlService rewired to use gateway client for all 10 gateway-dependent methods
- Gateway failures handled gracefully with fallback responses
- Backend builds and insurance API endpoints return mock data
</success_criteria>

<output>
After completion, create `.planning/phases/01-bhxh-gateway-xml4210/01-01-SUMMARY.md`
</output>
