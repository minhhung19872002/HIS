---
phase: 03-security-hardening-cccd
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/HIS.Infrastructure/Security/EncryptedStringConverter.cs
  - backend/src/HIS.Infrastructure/Data/HISDbContext.cs
  - backend/src/HIS.Infrastructure/Services/SystemCompleteService.cs
  - backend/src/HIS.API/Program.cs
  - scripts/enable_tde.sql
  - scripts/migrate_encrypted_columns.sql
autonomous: true
requirements: [SEC-02, SEC-05]

must_haves:
  truths:
    - "Patient CCCD, phone, email, and insurance numbers are encrypted at rest in the database"
    - "Existing plaintext patient data is migrated to encrypted format without data loss"
    - "SQL Server TDE is enabled, encrypting data files and backup files"
    - "SystemCompleteService uses BCrypt for password hashing (not SHA256)"
    - "CCCD validation is already working on patient registration (SEC-05 pre-existing)"
  artifacts:
    - path: "backend/src/HIS.Infrastructure/Security/EncryptedStringConverter.cs"
      provides: "AES column encryption via EF Core ValueConverter using Data Protection API"
      min_lines: 40
    - path: "scripts/enable_tde.sql"
      provides: "SQL Server TDE setup with certificate backup"
      contains: "CREATE DATABASE ENCRYPTION KEY"
    - path: "scripts/migrate_encrypted_columns.sql"
      provides: "One-time migration of existing plaintext to encrypted values"
      contains: "UPDATE Patients"
  key_links:
    - from: "backend/src/HIS.Infrastructure/Security/EncryptedStringConverter.cs"
      to: "backend/src/HIS.Infrastructure/Data/HISDbContext.cs"
      via: "HasConversion on Patient.IdentityNumber, PhoneNumber, InsuranceNumber, Email"
      pattern: "HasConversion.*EncryptedStringConverter"
    - from: "backend/src/HIS.API/Program.cs"
      to: "Data Protection API"
      via: "AddDataProtection() service registration"
      pattern: "AddDataProtection"
---

<objective>
Implement data encryption at rest for sensitive patient data (SEC-02) and fix the SHA256 password hashing vulnerability.

Purpose: Level 6 certification requires patient PII to be encrypted at rest per Decree 85/2016. The system currently stores CCCD, phone, email, and insurance numbers as plaintext in the database. Additionally, SystemCompleteService.HashPassword uses SHA256 instead of BCrypt, creating a security vulnerability for admin-created users.

Output: EncryptedStringConverter for column-level AES encryption via Data Protection API, TDE SQL script for full-database encryption, plaintext migration script, and BCrypt password hash fix. SEC-05 is verified as pre-existing.
</objective>

<execution_context>
@C:/Users/ADMIN/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ADMIN/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-security-hardening-cccd/03-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. -->

From backend/src/HIS.Core/Entities/Patient.cs:
```csharp
public class Patient : BaseEntity
{
    public string? IdentityNumber { get; set; } // CCCD/CMND — encrypt
    public string? PhoneNumber { get; set; }     // encrypt
    public string? Email { get; set; }            // encrypt
    public string? InsuranceNumber { get; set; }  // encrypt
    // ... other fields unchanged
}
```

From backend/src/HIS.Infrastructure/Data/HISDbContext.cs (existing ValueConverter pattern):
```csharp
// Already used for Guid/String conversion on 31 tables
// Same HasConversion pattern applies for encryption
```

From backend/src/HIS.Infrastructure/Services/SystemCompleteService.cs:
```csharp
// CURRENT (vulnerable):
private static string HashPassword(string password)
{
    using var sha256 = System.Security.Cryptography.SHA256.Create();
    var bytes = System.Text.Encoding.UTF8.GetBytes(password);
    var hash = sha256.ComputeHash(bytes);
    return Convert.ToBase64String(hash);
}
// MUST CHANGE TO: BCrypt.Net.BCrypt.HashPassword(password)
```

From backend/src/HIS.Application/DTOs/Common/CccdValidator.cs:
```csharp
// Already fully implemented with 51 province codes
// GET /api/reception/validate-cccd endpoint exists
// Frontend validation in Reception.tsx exists
// SEC-05 is COMPLETE — just verify it works
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement column-level encryption and fix SHA256 password hashing</name>
  <files>
    backend/src/HIS.Infrastructure/Security/EncryptedStringConverter.cs
    backend/src/HIS.Infrastructure/Data/HISDbContext.cs
    backend/src/HIS.Infrastructure/Services/SystemCompleteService.cs
    backend/src/HIS.API/Program.cs
  </files>
  <action>
1. Create directory `backend/src/HIS.Infrastructure/Security/` if not exists.

2. Create `EncryptedStringConverter.cs` — a ValueConverter<string, string> that uses ASP.NET Core Data Protection API:
   - Constructor takes IDataProtectionProvider, creates protector with purpose "HIS.PatientPII"
   - Encrypt: if null/empty return as-is; call protector.Protect(value)
   - Decrypt: if null/empty return as-is; try protector.Unprotect(value), catch CryptographicException and return value as-is (graceful fallback for pre-encryption plaintext data)
   - Use `Microsoft.AspNetCore.DataProtection` namespace (built-in, no new package)

3. In `Program.cs`, add Data Protection registration BEFORE `builder.Build()`:
   ```csharp
   builder.Services.AddDataProtection()
       .PersistKeysToFileSystem(new DirectoryInfo(
           Path.Combine(builder.Environment.ContentRootPath, "App_Data", "DataProtection-Keys")))
       .SetApplicationName("HIS");
   ```
   Create directory `App_Data/DataProtection-Keys` in .gitignore if not already.

4. In `HISDbContext.cs`, modify `OnModelCreating` to add encrypted conversions on Patient entity:
   - The DbContext needs access to IDataProtectionProvider. Add it as a constructor parameter or use a static accessor pattern.
   - IMPORTANT: Since HISDbContext is registered by DI, inject IDataProtectionProvider via constructor. Add a private field. In OnModelCreating, apply HasConversion to:
     - Patient.IdentityNumber
     - Patient.PhoneNumber
     - Patient.Email
     - Patient.InsuranceNumber
   - Use the EncryptedStringConverter with the injected provider.
   - The existing Guid/String ValueConverter pattern is the template — follow the same style.
   - CRITICAL: The Decrypt must handle plaintext gracefully (try/catch) because existing data is unencrypted.

5. Fix `SystemCompleteService.HashPassword`:
   - Change from SHA256 to `BCrypt.Net.BCrypt.HashPassword(password)` (BCrypt.Net-Next is already a project dependency, used in AuthService)
   - Also fix `ResetUserPasswordAsync` which uses the same method
   - Also fix `ChangeUserPasswordAsync`
   - Remove the SHA256 using block entirely

6. Add `App_Data/` to `.gitignore` if not present (Data Protection keys should not be committed).
  </action>
  <verify>
    <automated>cd C:/Source/HIS/backend/src/HIS.Infrastructure && dotnet build --no-restore 2>&1 | tail -5 && cd C:/Source/HIS/backend/src/HIS.API && dotnet build --no-restore 2>&1 | tail -5</automated>
  </verify>
  <done>
    - EncryptedStringConverter.cs exists with Protect/Unprotect using Data Protection API
    - HISDbContext applies encryption converter to Patient.IdentityNumber, PhoneNumber, Email, InsuranceNumber
    - SystemCompleteService.HashPassword uses BCrypt (not SHA256)
    - Data Protection registered in Program.cs with file system key persistence
    - Backend builds with 0 errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TDE and migration SQL scripts, verify SEC-05</name>
  <files>
    scripts/enable_tde.sql
    scripts/migrate_encrypted_columns.sql
  </files>
  <action>
1. Create `scripts/enable_tde.sql` — idempotent TDE setup for SQL Server:
   ```sql
   -- TDE Setup for HIS Database
   -- Run as SA on the SQL Server instance
   -- NOTE: Developer edition supports TDE

   USE master;
   GO

   -- Step 1: Create master key (if not exists)
   IF NOT EXISTS (SELECT * FROM sys.symmetric_keys WHERE name = '##MS_DatabaseMasterKey##')
       CREATE MASTER KEY ENCRYPTION BY PASSWORD = 'HIS_TDE_MasterKey!2026';
   GO

   -- Step 2: Create certificate for TDE (if not exists)
   IF NOT EXISTS (SELECT * FROM sys.certificates WHERE name = 'HIS_TDE_Cert')
       CREATE CERTIFICATE HIS_TDE_Cert WITH SUBJECT = 'HIS TDE Certificate';
   GO

   -- Step 3: IMMEDIATELY backup certificate (CRITICAL - without this, backups are unrecoverable)
   BACKUP CERTIFICATE HIS_TDE_Cert
       TO FILE = '/var/opt/mssql/backup/HIS_TDE_Cert.cer'
       WITH PRIVATE KEY (
           FILE = '/var/opt/mssql/backup/HIS_TDE_Cert_Key.pvk',
           ENCRYPTION BY PASSWORD = 'HIS_CertBackup!2026'
       );
   GO

   -- Step 4: Create database encryption key and enable TDE
   USE HIS;
   GO

   IF NOT EXISTS (SELECT * FROM sys.dm_database_encryption_keys WHERE database_id = DB_ID())
   BEGIN
       CREATE DATABASE ENCRYPTION KEY
           WITH ALGORITHM = AES_256
           ENCRYPTION BY SERVER CERTIFICATE HIS_TDE_Cert;
       ALTER DATABASE HIS SET ENCRYPTION ON;
   END
   GO

   -- Verify TDE status
   SELECT db.name, dek.encryption_state, dek.key_algorithm, dek.key_length
   FROM sys.dm_database_encryption_keys dek
   JOIN sys.databases db ON dek.database_id = db.database_id
   WHERE db.name = 'HIS';
   GO
   ```

2. Create `scripts/migrate_encrypted_columns.sql` as a documentation/placeholder:
   ```sql
   -- Column-level encryption migration
   -- NOTE: Column encryption is handled automatically by EF Core ValueConverter.
   -- When the application reads existing plaintext data, the Decrypt method
   -- gracefully returns it as-is. When the record is next saved (any field update),
   -- EF Core will encrypt the sensitive fields via the converter.
   --
   -- For bulk migration, run this one-time script via the application:
   -- POST /api/security/migrate-encryption
   -- This endpoint reads all patients, touches each record, and SaveChanges
   -- triggers encryption via the ValueConverter.
   --
   -- Alternatively, no action needed — data encrypts lazily on next save.
   -- TDE (enable_tde.sql) already encrypts the entire database at the file level.

   PRINT 'Column-level encryption is handled by EF Core ValueConverter (EncryptedStringConverter).'
   PRINT 'Existing plaintext data is gracefully read and encrypted on next save.'
   PRINT 'TDE provides file-level encryption for all data at rest.'
   PRINT 'Run enable_tde.sql first, then column encryption happens automatically.'
   GO
   ```

3. Verify SEC-05 (CCCD validation) is already working:
   - Confirm CccdValidator.cs exists at `backend/src/HIS.Application/DTOs/Common/CccdValidator.cs`
   - Confirm `GET /api/reception/validate-cccd` endpoint exists
   - Confirm frontend validation in Reception.tsx exists
   - SEC-05 is ALREADY COMPLETE from Session 18 (commit 01fc52b)
   - No code changes needed — just verify files exist
  </action>
  <verify>
    <automated>test -f C:/Source/HIS/scripts/enable_tde.sql && test -f C:/Source/HIS/scripts/migrate_encrypted_columns.sql && test -f C:/Source/HIS/backend/src/HIS.Application/DTOs/Common/CccdValidator.cs && echo "All files exist" || echo "MISSING FILES"</automated>
  </verify>
  <done>
    - enable_tde.sql exists with idempotent TDE setup + certificate backup
    - migrate_encrypted_columns.sql exists with migration documentation
    - CccdValidator.cs confirmed present (SEC-05 pre-existing)
    - GET /api/reception/validate-cccd endpoint confirmed present
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds for HIS.Infrastructure and HIS.API projects with 0 errors
2. SQL scripts are syntactically valid (idempotent, IF NOT EXISTS guards)
3. EncryptedStringConverter handles both encrypted and plaintext data gracefully
4. SystemCompleteService.HashPassword uses BCrypt.Net (grep confirms no SHA256)
5. CccdValidator.cs exists and SEC-05 is confirmed complete
</verification>

<success_criteria>
- Backend builds with 0 errors after encryption converter + BCrypt changes
- Patient PII fields (IdentityNumber, PhoneNumber, Email, InsuranceNumber) have encryption converters applied in HISDbContext
- SHA256 password hashing eliminated from SystemCompleteService
- TDE SQL script ready for execution on SQL Server
- SEC-05 confirmed as pre-existing (no changes needed)
</success_criteria>

<output>
After completion, create `.planning/phases/03-security-hardening-cccd/03-01-SUMMARY.md`
</output>
