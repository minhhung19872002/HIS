---
phase: 03-security-hardening-cccd
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - frontend/src/api/security.ts
  - frontend/src/pages/SystemAdmin.tsx
  - docs/access-control-matrix.md
  - docs/backup-procedures.md
  - docs/incident-response-plan.md
  - frontend/cypress/e2e/security-compliance.cy.ts
autonomous: true
requirements: [SEC-01, SEC-03, SEC-04]

must_haves:
  truths:
    - "An admin can view the access control matrix in the SystemAdmin page"
    - "An admin can trigger backup and view backup history from the UI"
    - "Compliance summary dashboard shows security posture at a glance"
    - "Access control matrix document exists for Level 6 auditor"
    - "Backup procedures document exists with step-by-step instructions"
    - "Security incident response plan document exists per Decree 85/2016"
    - "Cypress tests verify security API endpoints return expected data"
  artifacts:
    - path: "frontend/src/api/security.ts"
      provides: "Frontend API client for security compliance endpoints"
      exports: ["getAccessControlMatrix", "getSensitiveAccessReport", "getComplianceSummary"]
    - path: "docs/access-control-matrix.md"
      provides: "Decree 85/2016 access control matrix documentation for Level 6 audit"
      min_lines: 80
    - path: "docs/backup-procedures.md"
      provides: "Backup and recovery procedures document for Level 6 audit"
      min_lines: 60
    - path: "docs/incident-response-plan.md"
      provides: "Security incident response plan for Level 6 audit"
      min_lines: 80
    - path: "frontend/cypress/e2e/security-compliance.cy.ts"
      provides: "Cypress tests for security compliance features"
      min_lines: 50
  key_links:
    - from: "frontend/src/api/security.ts"
      to: "/api/security/compliance/*"
      via: "axios GET requests"
      pattern: "apiClient.get.*security"
    - from: "frontend/src/pages/SystemAdmin.tsx"
      to: "frontend/src/api/security.ts"
      via: "import and useEffect data loading"
      pattern: "import.*security"
---

<objective>
Create frontend compliance UI, security compliance documentation, and Cypress tests for Phase 3 security features (SEC-01, SEC-03, SEC-04).

Purpose: Level 6 certification requires both working systems AND documentation that can be presented to auditors. This plan creates the frontend UI for viewing compliance data, the three mandatory compliance documents (access control matrix, backup procedures, incident response plan), and Cypress tests to verify all security features.

Output: Security API client, enhanced SystemAdmin page with compliance tabs, three compliance documents, and comprehensive Cypress test suite.
</objective>

<execution_context>
@C:/Users/ADMIN/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ADMIN/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-security-hardening-cccd/03-RESEARCH.md
@.planning/phases/03-security-hardening-cccd/03-01-SUMMARY.md
@.planning/phases/03-security-hardening-cccd/03-02-SUMMARY.md

<interfaces>
<!-- Endpoints created by Plan 01 and Plan 02 that this plan consumes -->

From backend/src/HIS.API/Controllers/SecurityController.cs (created in Plan 02):
```
GET /api/security/compliance/access-matrix    → List<AccessControlMatrixDto>
GET /api/security/compliance/sensitive-access  → List<SensitiveDataAccessReportDto>
GET /api/security/compliance/summary          → ComplianceSummaryDto
```

From backend/src/HIS.Application/DTOs/Security/SecurityComplianceDTOs.cs (created in Plan 02):
```typescript
// Frontend equivalent types:
interface AccessControlMatrixDto {
  roleCode: string;
  roleName: string;
  description?: string;
  userCount: number;
  modulePermissions: { module: string; permissions: { permissionCode: string; permissionName: string; description?: string }[] }[];
}

interface SensitiveDataAccessReportDto {
  userId: string;
  userName: string;
  userFullName: string;
  totalAccesses: number;
  recentAccesses: { timestamp: string; entityType: string; entityId: string; requestPath: string; module: string }[];
}

interface ComplianceSummaryDto {
  totalRoles: number;
  totalPermissions: number;
  totalUsers: number;
  activeUsers: number;
  usersWithTwoFactor: number;
  tdeEnabled: boolean;
  columnEncryptionEnabled: boolean;
  lastBackupDate?: string;
  auditLogsLast30Days: number;
  sensitiveAccessLast30Days: number;
}
```

From existing SystemAdmin.tsx tabs structure:
- Tab "Nguoi dung" (Users)
- Tab "Vai tro" (Roles)
- Tab "Quyen han" (Permissions)
- Tab "Cau hinh" (System Config)
- Tab "Nhat ky he thong" (Audit Logs)
- Tab "Thong bao" (Notifications)
- Tab "Sao luu" (Backup)
- NEW tabs to add: "Ma tran quyen" (Access Matrix), "Tuan thu" (Compliance)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create security API client, frontend compliance UI, and Cypress tests</name>
  <files>
    frontend/src/api/security.ts
    frontend/src/pages/SystemAdmin.tsx
    frontend/cypress/e2e/security-compliance.cy.ts
  </files>
  <action>
1. Create `frontend/src/api/security.ts`:
   ```typescript
   import { apiClient } from './client';

   // Types matching backend DTOs
   export interface AccessControlMatrixDto { ... }
   export interface SensitiveDataAccessReportDto { ... }
   export interface ComplianceSummaryDto { ... }

   export const getAccessControlMatrix = () =>
     apiClient.get<AccessControlMatrixDto[]>('/security/compliance/access-matrix');

   export const getSensitiveAccessReport = (from: string, to: string, limit?: number) =>
     apiClient.get<SensitiveDataAccessReportDto[]>('/security/compliance/sensitive-access', {
       params: { from, to, limit: limit ?? 50 }
     });

   export const getComplianceSummary = () =>
     apiClient.get<ComplianceSummaryDto>('/security/compliance/summary');
   ```

2. Enhance `SystemAdmin.tsx` with two new tabs:

   **Tab "Ma tran quyen" (Access Control Matrix):**
   - Load data from getAccessControlMatrix() on tab activation
   - Display as a table: columns = Role Code, Role Name, User Count, and then one column per module showing permission count or checkmark
   - Expandable rows showing individual permissions per module
   - "Xuat bao cao" (Export) button that opens print preview
   - Use Antd Table with expandable rows
   - Color code: Admin role in blue, clinical roles in green, support roles in gray

   **Tab "Tuan thu" (Compliance Dashboard):**
   - Load ComplianceSummaryDto on tab activation
   - Display as Statistic cards (Antd Card + Statistic):
     - Total Users / Active Users
     - Users with 2FA enabled (percentage)
     - TDE Status (green check / red X)
     - Column Encryption Status
     - Last Backup Date (with warning if > 24h ago)
     - Audit Logs (30 days)
     - Sensitive Data Accesses (30 days)
   - Below cards: Sensitive Data Access Report table
     - Date range picker (default: last 7 days)
     - Table: User, Total Accesses, Most Recent, Entity Type
     - Expandable row showing recent access entries
   - "Lam moi" (Refresh) button

   Use existing SystemAdmin.tsx patterns: same Tabs structure, same loading/error pattern, same Antd components. Add the two tabs after the existing "Sao luu" tab. Import from security.ts.

3. Create `frontend/cypress/e2e/security-compliance.cy.ts`:
   - Login as admin before each test
   - Test group "Security Compliance API":
     - GET /api/security/compliance/access-matrix returns 200 with array
     - GET /api/security/compliance/summary returns 200 with expected fields
     - GET /api/security/compliance/sensitive-access returns 200
   - Test group "Backup API":
     - POST /api/system/backup with { backupName: "cypress_test", backupType: "Full" } returns 200 (or 500 if Docker permissions — accept both)
     - GET /api/system/backups returns 200 with array
   - Test group "Audit Enhancement":
     - GET /api/patients (list) should NOT create audit log (verify by checking audit count before/after)
     - GET /api/reception/validate-cccd?cccd=123456789012 returns 200 (SEC-05 verification)
   - Test group "SystemAdmin Compliance UI":
     - Navigate to /system-admin, verify "Ma tran quyen" tab exists
     - Navigate to /system-admin, verify "Tuan thu" tab exists
     - Click "Tuan thu" tab, verify Statistic cards render
   - Test group "Console Errors":
     - /system-admin loads without console errors (add to existing console-errors pattern)
   - Use `cy.request` for API tests, standard navigation for UI tests
   - Follow project patterns: `cy.intercept('**/api/**')` not `**/*`
  </action>
  <verify>
    <automated>cd C:/Source/HIS/frontend && npx tsc --noEmit 2>&1 | tail -5 && npx cypress run --spec "cypress/e2e/security-compliance.cy.ts" --browser chrome 2>&1 | tail -20</automated>
  </verify>
  <done>
    - security.ts API client with 3 functions (getAccessControlMatrix, getSensitiveAccessReport, getComplianceSummary)
    - SystemAdmin has "Ma tran quyen" tab showing role-permission matrix
    - SystemAdmin has "Tuan thu" tab showing compliance dashboard with statistics and sensitive access report
    - Cypress tests pass: API endpoints return 200, UI tabs render, CCCD validation works
    - TypeScript: 0 errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create compliance documentation for Level 6 audit</name>
  <files>
    docs/access-control-matrix.md
    docs/backup-procedures.md
    docs/incident-response-plan.md
  </files>
  <action>
1. Create `docs/access-control-matrix.md` — Decree 85/2016 compliant access control matrix:
   - Title: "MA TRAN KIEM SOAT TRUY CAP - BENH VIEN DA KHOA" (Access Control Matrix)
   - Reference: Decree 85/2016/ND-CP, Circular 12/2022/TT-BTTTT
   - Sections:
     a. Gioi thieu (Introduction): purpose of access control, regulatory basis
     b. Danh sach vai tro (Role Definitions): 8 roles with descriptions in Vietnamese
     c. Ma tran quyen (Permission Matrix): table format showing Role x Module x Permission (Read/Write/Delete/Admin)
     d. Modules covered: Tiep don, Kham benh, Noi tru, Nha thuoc, Thu ngan, Xet nghiem, Chan doan hinh anh, Ho so benh an, Danh muc, Quan tri
     e. Chinh sach mat khau (Password Policy): min 8 chars, BCrypt hashing, 2FA available
     f. Chinh sach phien (Session Policy): JWT 15-min access token, re-login required
     g. Nhat ky truy cap (Audit Trail): what is logged (all CUD + sensitive GET), retention policy
     h. Ky duyet (Sign-off section): blank lines for hospital director, IT director, security officer

2. Create `docs/backup-procedures.md` — Backup and Recovery Procedures:
   - Title: "QUY TRINH SAO LUU VA KHOI PHUC DU LIEU" (Backup and Recovery Procedures)
   - Reference: Decree 85/2016, Circular 13/2025 Art.6
   - Sections:
     a. Muc dich (Purpose)
     b. Pham vi (Scope): SQL Server database, uploaded files, Data Protection keys
     c. Loai sao luu (Backup Types): Full (daily 23:00), Differential (every 6h), Transaction Log (every 30min)
     d. Quy trinh sao luu (Backup Procedure): step-by-step with T-SQL commands and UI instructions
     e. Quy trinh khoi phuc (Recovery Procedure): step-by-step restore with SINGLE_USER mode
     f. TDE certificate management: where certs are stored, how to restore on new server
     g. Kiem tra sao luu (Backup Verification): monthly restore test procedure
     h. Luu tru (Retention): Full backups 30 days, differential 7 days, log 3 days
     i. Trach nhiem (Responsibilities): who does what (IT admin, DBA, security officer)
     j. Lich sao luu (Schedule): table showing daily/weekly/monthly schedule

3. Create `docs/incident-response-plan.md` — Security Incident Response Plan:
   - Title: "KE HOACH UNG PHO SU CO AN TOAN THONG TIN" (Information Security Incident Response Plan)
   - Reference: Decree 85/2016, Circular 20/2017/TT-BTTTT
   - Sections:
     a. Muc dich va pham vi (Purpose and Scope)
     b. Phan loai su co (Incident Classification):
        - Muc 1 (Critical): data breach, ransomware, system compromise
        - Muc 2 (Major): unauthorized access, data corruption, extended outage
        - Muc 3 (Minor): failed login attempts, policy violations, single system failure
        - Muc 4 (Informational): vulnerability scan findings, configuration drift
     c. Doi ung pho su co (Incident Response Team): roles and contact info (template)
     d. Quy trinh xu ly su co (Incident Response Procedure):
        1. Phat hien (Detection): monitoring alerts, user reports, audit log anomalies
        2. Phan loai (Classification): severity assessment
        3. Ngan chan (Containment): isolate affected systems, preserve evidence
        4. Xu ly (Eradication): remove threat, patch vulnerability
        5. Khoi phuc (Recovery): restore from backup, verify integrity
        6. Bao cao (Reporting): internal report, regulatory notification if Level 1-2
        7. Rut kinh nghiem (Lessons Learned): post-incident review
     e. Bao cao su co (Incident Reporting Template): form with fields
     f. Lien he khan cap (Emergency Contacts): template table
     g. Kiem tra va cap nhat (Review Schedule): quarterly review, annual drill
     h. Phu luc (Appendix): incident response checklist, communication template

   All three documents in Vietnamese with professional medical/IT terminology.
   Use markdown tables for matrices, numbered lists for procedures.
   Include blank signature lines for hospital approval.
  </action>
  <verify>
    <automated>test -f C:/Source/HIS/docs/access-control-matrix.md && test -f C:/Source/HIS/docs/backup-procedures.md && test -f C:/Source/HIS/docs/incident-response-plan.md && wc -l C:/Source/HIS/docs/access-control-matrix.md C:/Source/HIS/docs/backup-procedures.md C:/Source/HIS/docs/incident-response-plan.md</automated>
  </verify>
  <done>
    - access-control-matrix.md: 80+ lines, covers 8 roles x 10 modules, Decree 85 compliant
    - backup-procedures.md: 60+ lines, step-by-step backup/restore, TDE cert management, schedule
    - incident-response-plan.md: 80+ lines, 4-level classification, 7-step procedure, Vietnamese
    - All documents ready for hospital director sign-off and Level 6 auditor review
  </done>
</task>

</tasks>

<verification>
1. `tsc --noEmit` passes with 0 errors
2. Cypress security-compliance tests pass
3. Three compliance documents exist with sufficient content (80+, 60+, 80+ lines)
4. SystemAdmin page loads without console errors with new tabs
5. Security API endpoints return valid data
</verification>

<success_criteria>
- Frontend displays access control matrix and compliance dashboard
- Three compliance documents exist in docs/ directory
- Cypress tests verify security APIs and CCCD validation (SEC-05)
- SystemAdmin "Ma tran quyen" and "Tuan thu" tabs are functional
- All documentation in Vietnamese with Decree 85/2016 references
</success_criteria>

<output>
After completion, create `.planning/phases/03-security-hardening-cccd/03-03-SUMMARY.md`
</output>
