---
phase: 02-digital-signature-expansion-pkcs-11-tsa
plan: 03
type: execute
wave: 2
depends_on:
  - 02-01
  - 02-02
files_modified:
  - frontend/src/api/digitalSignature.ts
  - frontend/src/components/PinEntryModal.tsx
  - frontend/src/components/SignatureStatusIcon.tsx
  - frontend/src/components/SignatureVerificationPanel.tsx
  - frontend/src/components/BatchSigningModal.tsx
  - frontend/src/contexts/SigningContext.tsx
autonomous: true
requirements:
  - SIGN-01
  - SIGN-06

must_haves:
  truths:
    - "Doctor can enter USB Token PIN in an HTML input field in the browser"
    - "Green shield icon shown next to signed documents; gray icon for unsigned"
    - "Hover tooltip on shield icon shows signer name, datetime, CA provider"
    - "Click shield icon opens verification panel with TSA timestamp, OCSP status, cert chain"
    - "Batch signing modal shows checkbox-selected documents, progress bar with counter, green/red per-document status"
    - "PIN entry required only when no active session; session indicator shown when session active"
    - "Signed documents are locked -- no edit or delete buttons shown"
  artifacts:
    - path: "frontend/src/api/digitalSignature.ts"
      provides: "API client for all signing endpoints"
      exports: ["openSession", "getSessionStatus", "closeSession", "signDocument", "batchSign", "getSignatureInfo"]
    - path: "frontend/src/components/PinEntryModal.tsx"
      provides: "PIN input modal with session status indicator"
      contains: "PinEntryModal"
    - path: "frontend/src/components/SignatureStatusIcon.tsx"
      provides: "Green/gray shield icon with tooltip"
      contains: "SignatureStatusIcon"
    - path: "frontend/src/components/SignatureVerificationPanel.tsx"
      provides: "Detailed verification drawer with cert chain, TSA, OCSP"
      contains: "SignatureVerificationPanel"
    - path: "frontend/src/components/BatchSigningModal.tsx"
      provides: "Batch signing UI with progress bar and real-time SignalR updates"
      contains: "BatchSigningModal"
    - path: "frontend/src/contexts/SigningContext.tsx"
      provides: "Signing session state management with SignalR progress listener"
      contains: "SigningProvider"
  key_links:
    - from: "digitalSignature.ts"
      to: "/api/digital-signature/*"
      via: "axios HTTP calls to backend controller"
      pattern: "apiClient\\.(get|post)"
    - from: "BatchSigningModal"
      to: "SignalR hub"
      via: "SigningContext listens for SigningProgress events"
      pattern: "connection.on.*SigningProgress"
    - from: "SignatureStatusIcon"
      to: "SignatureVerificationPanel"
      via: "Click handler opens drawer"
      pattern: "onVerifyClick"
---

<objective>
Build all frontend signing UI components: PIN entry modal, signature status icon (green/gray shield), verification detail panel, batch signing modal with real-time progress, API client, and signing context.

Purpose: Doctors interact with the signing system entirely through the browser. No Windows dialogs, no driver installations on workstations. The UI must clearly communicate signing status, session state, and batch progress.
Output: Reusable React components that any page (EMR, Prescription, Lab, etc.) can import to enable document signing.
</objective>

<execution_context>
@C:/Users/ADMIN/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ADMIN/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-digital-signature-expansion-pkcs-11-tsa/02-CONTEXT.md
@.planning/phases/02-digital-signature-expansion-pkcs-11-tsa/02-RESEARCH.md
@.planning/phases/02-digital-signature-expansion-pkcs-11-tsa/02-01-SUMMARY.md
@.planning/phases/02-digital-signature-expansion-pkcs-11-tsa/02-02-SUMMARY.md

<interfaces>
<!-- From Plan 02-01: Backend controller endpoints -->
```
POST   /api/digital-signature/open-session    { pin: string }
GET    /api/digital-signature/session-status
POST   /api/digital-signature/close-session
GET    /api/digital-signature/tokens           (admin only)
POST   /api/digital-signature/register-token   { tokenSerial: string }
POST   /api/digital-signature/sign             { documentId, documentType, pin?, reason, location }
POST   /api/digital-signature/batch-sign       { documentIds[], documentType, pin?, reason }
GET    /api/digital-signature/signatures/{documentId}
GET    /api/digital-signature/signatures/by-type/{documentType}?page=1&pageSize=20
```

<!-- From Plan 02-01: DTOs (TypeScript equivalents needed) -->
```typescript
interface OpenSessionRequest { pin: string }
interface OpenSessionResponse { success: boolean; message?: string; tokenSerial?: string; caProvider?: string; certificateSubject?: string; sessionExpiresAt?: string }
interface SessionStatusResponse { active: boolean; expiresAt?: string; tokenSerial?: string; caProvider?: string; certificateSubject?: string; expiryWarningDays?: number }
interface SignDocumentRequest { documentId: string; documentType: string; pin?: string; reason: string; location: string }
interface SignDocumentResponse { success: boolean; message?: string; signerName?: string; signedAt?: string; certificateSerial?: string; caProvider?: string; tsaTimestamp?: string; ocspStatus?: string; signedDocumentUrl?: string }
interface BatchSignRequest { documentIds: string[]; documentType: string; pin?: string; reason: string }
interface BatchSignResponse { total: number; succeeded: number; failed: number; results: BatchSignItemResult[] }
interface BatchSignItemResult { documentId: string; success: boolean; error?: string }
interface DocumentSignatureDto { id: string; documentId: string; documentType: string; documentCode: string; signerName: string; signedAt: string; certificateSerial: string; caProvider: string; tsaTimestamp?: string; ocspStatus?: string; status: number }
```

<!-- Existing frontend patterns -->
From frontend/src/api/client.ts:
```typescript
import axios from 'axios';
const apiClient = axios.create({ baseURL: import.meta.env.VITE_API_URL || 'http://localhost:5106/api' });
// Interceptor adds Authorization: Bearer token from localStorage
```

From frontend/src/contexts/NotificationContext.tsx:
```typescript
// SignalR connection pattern to reuse:
const connection = new HubConnectionBuilder()
  .withUrl(`${baseUrl}/hubs/notifications`, { accessTokenFactory: () => token })
  .withAutomaticReconnect([0, 2000, 5000, 10000, 30000])
  .build();
```

Antd v6 patterns used throughout project:
- Modal with `destroyOnHidden` (not destroyOnClose)
- Input.OTP for PIN entry (used in 2FA Login.tsx)
- Drawer for side panels
- Tooltip for hover info
- Tag with color for status badges
- Progress component for progress bars
- Checkbox in Table for row selection
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create digitalSignature API client and SigningContext with SignalR integration</name>
  <files>
    frontend/src/api/digitalSignature.ts
    frontend/src/contexts/SigningContext.tsx
  </files>
  <action>
    1. **Create `frontend/src/api/digitalSignature.ts`** (~100 lines): Centralized API client for signing operations.
       - Import `apiClient` from `../api/client`.
       - Define all TypeScript interfaces matching the backend DTOs listed in the interfaces section above.
       - Export functions:
         - `openSession(data: OpenSessionRequest)` -> POST `/digital-signature/open-session`
         - `getSessionStatus()` -> GET `/digital-signature/session-status`
         - `closeSession()` -> POST `/digital-signature/close-session`
         - `getTokens()` -> GET `/digital-signature/tokens`
         - `registerToken(data: { tokenSerial: string })` -> POST `/digital-signature/register-token`
         - `signDocument(data: SignDocumentRequest)` -> POST `/digital-signature/sign`
         - `batchSign(data: BatchSignRequest)` -> POST `/digital-signature/batch-sign`
         - `getSignatureInfo(documentId: string)` -> GET `/digital-signature/signatures/${documentId}`
         - `getSignaturesByType(documentType: string, page?: number)` -> GET `/digital-signature/signatures/by-type/${documentType}?page=${page}&pageSize=20`

    2. **Create `frontend/src/contexts/SigningContext.tsx`** (~180 lines): React context managing signing session state and SignalR progress events.
       - **State:**
         - `sessionActive: boolean` -- whether a PKCS#11 session is open
         - `sessionExpiresAt: string | null`
         - `tokenSerial: string | null`
         - `caProvider: string | null`
         - `certificateSubject: string | null`
         - `expiryWarningDays: number | null` -- non-null if cert expires within 30 days
         - `batchProgress: { current: number; total: number; documentId: string; success: boolean } | null`
         - `isSigningBatch: boolean`
       - **SignalR connection** for signing progress:
         - Connect to the same `/hubs/notifications` hub (reuse existing NotificationHub -- the backend will send signing progress events to the user group).
         - Listen for `"SigningProgress"` event: update `batchProgress` state.
         - Listen for `"SigningComplete"` event: set `isSigningBatch = false`.
         - Do NOT create a separate hub -- reuse the existing NotificationHub per SignalR best practices.
         - If NotificationContext already manages the connection, accept a `connection` prop or coordinate with NotificationContext. Simplest approach: listen on the same HubConnection instance from NotificationContext by exporting it.
       - **Methods exposed via context:**
         - `openSession(pin: string): Promise<OpenSessionResponse>` -- calls API, updates state on success.
         - `closeSession(): Promise<void>` -- calls API, clears state.
         - `refreshSessionStatus(): Promise<void>` -- polls session status, updates state.
         - `signDocument(request: SignDocumentRequest): Promise<SignDocumentResponse>` -- if no session active and no pin in request, throw error indicating PIN required.
         - `startBatchSign(request: BatchSignRequest): Promise<BatchSignResponse>` -- sets isSigningBatch=true, calls API, waits for response.
       - **Auto-refresh**: useEffect with setInterval every 60 seconds to call `refreshSessionStatus`. Clear on unmount.
       - **Session expiry warning**: If `expiryWarningDays` is non-null (cert expires within 30 days), expose it for UI to show warning.
       - Wrap with `<SigningProvider>` component. Export `useSigningContext` hook.
       - Import `useAuth` from AuthContext to get current user token for API calls.
  </action>
  <verify>
    Run: `cd C:/Source/HIS/frontend && npx tsc --noEmit 2>&1 | tail -10`
    Expected: 0 TypeScript errors.
  </verify>
  <done>
    digitalSignature.ts exports all signing API functions with proper TypeScript interfaces. SigningContext manages session state, provides signing methods, and listens for SignalR batch progress events. Auto-refresh session status every 60 seconds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PinEntryModal, SignatureStatusIcon, SignatureVerificationPanel, and BatchSigningModal components</name>
  <files>
    frontend/src/components/PinEntryModal.tsx
    frontend/src/components/SignatureStatusIcon.tsx
    frontend/src/components/SignatureVerificationPanel.tsx
    frontend/src/components/BatchSigningModal.tsx
  </files>
  <action>
    1. **Create `PinEntryModal.tsx`** (~100 lines): Antd Modal for PIN entry with session indicator.
       - Props: `open: boolean`, `onSubmit: (pin: string) => Promise<void>`, `onCancel: () => void`, `loading: boolean`
       - Use `useSigningContext()` to check `sessionActive` and `sessionExpiresAt`.
       - If session is active: show green status bar "Phien ky so con hieu luc den {time}" with "Tiep tuc ky" button (no PIN needed).
       - If session is NOT active: show Input.OTP with 6-8 character input (USB Token PINs are typically 6-8 chars) styled as password. Use `<Input.Password>` with `size="large"` and placeholder "Nhap ma PIN USB Token".
       - "Ky so" primary button, "Huy" default button.
       - Certificate expiry warning: if `expiryWarningDays` from context is non-null, show Antd Alert type="warning" with title "Chung chi het han trong {days} ngay. Lien he phong CNTT."
       - Expired cert: show Alert type="error" with message from context.
       - Loading state: Spin overlay during signing operation.
       - Use `destroyOnHidden` (Antd v6 pattern, NOT `destroyOnClose`).

    2. **Create `SignatureStatusIcon.tsx`** (~80 lines): Shield icon with tooltip showing signing status.
       - Props: `signed: boolean`, `signatureInfo?: DocumentSignatureDto`, `onVerifyClick?: () => void`, `size?: 'small' | 'default'`
       - Per user decision:
         - Signed: Green `SafetyCertificateTwoTone` (twoToneColor="#52c41a") icon.
         - Unsigned: Gray `SafetyCertificateOutlined` icon with `style={{ color: '#d9d9d9' }}`.
       - Tooltip on hover (only when signed): "Da ky boi BS. {signerName}, {signedAt formatted}, {caProvider}". Use Antd `Tooltip`.
       - Click handler: if signed and `onVerifyClick` provided, call it (opens verification panel).
       - If unsigned and clickable: show tooltip "Chua ky so".
       - CSS: cursor pointer when clickable.

    3. **Create `SignatureVerificationPanel.tsx`** (~150 lines): Antd Drawer showing detailed signature verification.
       - Props: `open: boolean`, `onClose: () => void`, `signatureInfo: DocumentSignatureDto | null`
       - Drawer from right side, width 480.
       - Content sections:
         - **Thong tin nguoi ky**: Signer name, signing datetime (formatted Vietnamese), certificate serial, CA provider (with color Tag per provider).
         - **Trang thai chu ky**: Status badge (Active = green "Hop le", Revoked = red "Da thu hoi").
         - **Thoi gian TSA**: TSA timestamp if available, or gray "Khong co" if null. Show TSA server URL.
         - **Trang thai thu hoi (OCSP)**: OCSP status with color coding: "Good" = green Tag, "Revoked" = red Tag, "Unknown" = orange Tag, null = gray "Chua kiem tra".
         - **Chuoi chung thu**: Certificate subject, issuer, valid from/to dates. Show expiry warning if within 30 days.
         - **Hash algorithm**: Show algorithm used (SHA-256).
       - If `signatureInfo.status === 1` (Revoked): show Alert type="error" with revoke reason and revoke datetime.
       - Per user decision: "Signed documents are fully locked -- no editing or deletion allowed."

    4. **Create `BatchSigningModal.tsx`** (~180 lines): Modal for batch signing with real-time progress.
       - Props: `open: boolean`, `onClose: () => void`, `documents: Array<{ id: string; code: string; type: string; title: string }>`, `documentType: string`, `onComplete: (result: BatchSignResponse) => void`
       - Use `useSigningContext()` for `sessionActive`, `batchProgress`, `isSigningBatch`, `startBatchSign`, `openSession`.
       - **Before signing**: Show list of selected documents (Antd List with document code and title). Show count: "{N} tai lieu da chon". Max 50 per user decision.
       - **PIN entry phase**: If no session active, show inline PIN input at top. If session active, show green banner "Phien ky so dang hoat dong".
       - **During signing**:
         - Antd Progress bar showing `{batchProgress.current}/{batchProgress.total}` (e.g., "7/10 da ky").
         - Per user decision: Progress bar with counter updating in real-time.
         - Document list updates per-item: green CheckCircleTwoTone for success, red CloseCircleTwoTone for failure (with error tooltip).
         - Modal cannot be closed during signing (mask click disabled, close button hidden).
       - **After signing**:
         - Summary: "{succeeded} thanh cong, {failed} that bai" with color coding.
         - Per user decision: On partial failure, show all results. Success = green check, failure = red X with error reason.
         - "Dong" button to close.
       - **Implementation**: Call `startBatchSign({ documentIds, documentType, pin, reason: "Ky so hang loat" })`. SignalR events from SigningContext update `batchProgress` state in real-time.
  </action>
  <verify>
    Run: `cd C:/Source/HIS/frontend && npx tsc --noEmit 2>&1 | tail -10`
    Expected: 0 TypeScript errors.
    Run: `cd C:/Source/HIS/frontend && npx vite build 2>&1 | tail -5`
    Expected: Build succeeds.
  </verify>
  <done>
    PinEntryModal shows PIN input with session indicator and cert expiry warning. SignatureStatusIcon shows green/gray shield with hover tooltip per user decision. SignatureVerificationPanel drawer shows signer info, TSA timestamp, OCSP status, cert chain. BatchSigningModal shows document list, real-time progress bar with counter via SignalR, per-document success/failure status. All components use Antd v6 patterns and are reusable across EMR, Prescription, Lab, Discharge pages.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with 0 errors
2. `npx vite build` succeeds
3. All 6 files created with proper TypeScript types
4. SigningContext connects to SignalR hub for batch progress
5. PinEntryModal uses Input.Password (not OTP -- USB Token PINs can be 6-8 alphanumeric chars)
6. SignatureStatusIcon uses SafetyCertificateTwoTone/SafetyCertificateOutlined per signed/unsigned state
7. BatchSigningModal shows progress bar with real-time counter
</verification>

<success_criteria>
- TypeScript compiles with 0 errors
- Vite production build succeeds
- digitalSignature.ts exports all API functions matching backend controller endpoints
- SigningContext manages session state and SignalR progress
- PinEntryModal accepts PIN input and shows session status
- SignatureStatusIcon displays green/gray shield with Vietnamese tooltip
- SignatureVerificationPanel drawer shows full signature details
- BatchSigningModal handles progress updates and partial failure display
</success_criteria>

<output>
After completion, create `.planning/phases/02-digital-signature-expansion-pkcs-11-tsa/02-03-SUMMARY.md`
</output>
