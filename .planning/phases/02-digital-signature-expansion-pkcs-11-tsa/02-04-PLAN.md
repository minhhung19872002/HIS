---
phase: 02-digital-signature-expansion-pkcs-11-tsa
plan: 04
type: execute
wave: 2
depends_on:
  - 02-01
  - 02-02
files_modified:
  - backend/src/HIS.API/Controllers/DigitalSignatureController.cs
  - backend/src/HIS.Infrastructure/Services/DigitalSignatureService.cs
  - frontend/src/pages/EMR.tsx
  - frontend/src/pages/Prescription.tsx
  - frontend/src/pages/Laboratory.tsx
  - frontend/src/App.tsx
  - frontend/cypress/e2e/digital-signature.cy.ts
autonomous: true
requirements:
  - SIGN-02
  - SIGN-03
  - SIGN-06

must_haves:
  truths:
    - "Doctor can sign an EMR form from the EMR page using the signing pipeline"
    - "Doctor can sign a prescription from the Prescription page"
    - "Doctor can sign lab results from the Laboratory page"
    - "Batch sign endpoint accepts up to 50 documents and sends SignalR progress events"
    - "Signed documents show green shield icon in document lists"
    - "Signed documents are locked -- edit/delete buttons hidden when signature exists"
  artifacts:
    - path: "backend/src/HIS.API/Controllers/DigitalSignatureController.cs"
      provides: "Batch signing endpoint with SignalR progress"
      contains: "BatchSign"
    - path: "frontend/src/pages/EMR.tsx"
      provides: "Signing integration for EMR forms"
      contains: "SignatureStatusIcon"
    - path: "frontend/src/pages/Prescription.tsx"
      provides: "Signing integration for prescriptions"
      contains: "SignatureStatusIcon"
    - path: "frontend/cypress/e2e/digital-signature.cy.ts"
      provides: "E2E tests for signing UI components and API endpoints"
      min_lines: 60
  key_links:
    - from: "DigitalSignatureController.BatchSign"
      to: "IHubContext<NotificationHub>"
      via: "SignalR progress updates during batch loop"
      pattern: "_hubContext.Clients.Group.*SigningProgress"
    - from: "EMR.tsx"
      to: "SigningContext"
      via: "useSigningContext hook for session management"
      pattern: "useSigningContext"
    - from: "EMR.tsx"
      to: "SignatureStatusIcon + PinEntryModal + BatchSigningModal"
      via: "Component imports for signing UI"
      pattern: "import.*SignatureStatusIcon"
---

<objective>
Wire the signing pipeline into EMR, Prescription, and Laboratory pages. Implement batch signing with SignalR progress on the backend. Add signing UI to document lists. Create Cypress E2E tests.

Purpose: Connect the core infrastructure (Plan 01-02) and UI components (Plan 03) into working end-to-end signing workflows for all required document types. This is the integration plan that makes signing usable for doctors.
Output: Doctors can sign EMR forms, prescriptions, and lab results from their respective pages. Batch signing works with real-time progress. Cypress tests verify the complete flow.
</objective>

<execution_context>
@C:/Users/ADMIN/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ADMIN/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-digital-signature-expansion-pkcs-11-tsa/02-CONTEXT.md
@.planning/phases/02-digital-signature-expansion-pkcs-11-tsa/02-RESEARCH.md
@.planning/phases/02-digital-signature-expansion-pkcs-11-tsa/02-01-SUMMARY.md
@.planning/phases/02-digital-signature-expansion-pkcs-11-tsa/02-02-SUMMARY.md
@.planning/phases/02-digital-signature-expansion-pkcs-11-tsa/02-03-SUMMARY.md

<interfaces>
<!-- From Plan 02-01: DigitalSignatureController endpoints -->
```
POST /api/digital-signature/open-session
POST /api/digital-signature/sign
POST /api/digital-signature/batch-sign   <-- needs SignalR progress implementation
GET  /api/digital-signature/signatures/{documentId}
```

<!-- From Plan 02-01: DigitalSignatureService methods -->
```csharp
Task<SignDocumentResponse> SignDocumentAsync(string userId, SignDocumentRequest request);
// Uses IPdfGenerationService to generate HTML, PdfSignatureService to convert+sign
```

<!-- From Plan 02-03: Frontend components -->
```typescript
// SigningContext
useSigningContext(): {
  sessionActive, sessionExpiresAt, batchProgress, isSigningBatch,
  openSession, closeSession, signDocument, startBatchSign, refreshSessionStatus
}

// Components
<PinEntryModal open onSubmit onCancel loading />
<SignatureStatusIcon signed signatureInfo onVerifyClick />
<SignatureVerificationPanel open onClose signatureInfo />
<BatchSigningModal open onClose documents documentType onComplete />
```

<!-- Existing page patterns -->
From frontend/src/pages/EMR.tsx:
- Has print preview drawer for 38 EMR forms
- Table with examination list, row click for detail
- Print buttons for forms

From frontend/src/pages/Prescription.tsx:
- Has prescription table with actions column
- "Ke don" and print actions per prescription

From frontend/src/pages/Laboratory.tsx:
- Lab request list with status and actions
- Approve/finalize workflow

<!-- Backend SignalR already configured -->
```csharp
// Program.cs
builder.Services.AddSignalR();
app.MapHub<NotificationHub>("/hubs/notifications");
// JWT auth for SignalR already in OnMessageReceived
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement batch signing endpoint with SignalR progress and wire signing into document generation pipeline</name>
  <files>
    backend/src/HIS.API/Controllers/DigitalSignatureController.cs
    backend/src/HIS.Infrastructure/Services/DigitalSignatureService.cs
  </files>
  <action>
    1. **Add batch signing to `DigitalSignatureController.cs`**:
       - Inject `IHubContext<NotificationHub>` (reuse existing NotificationHub for progress events).
       - `POST /batch-sign` endpoint (~50 lines):
         - Validate `request.DocumentIds.Count <= 50` per user decision. Return 400 if exceeded: "Toi da 50 tai lieu moi lan ky".
         - Get userId from JWT claims.
         - Get or create PKCS#11 session: if `request.Pin` provided, open session; else check for existing cached session. Return 401 if no session and no PIN.
         - Loop through `request.DocumentIds`:
           - Call `_signatureService.SignDocumentAsync(userId, signRequest)` for each.
           - Track success/failure in `BatchSignResponse`.
           - After EACH document, send SignalR progress event to the user's group:
             ```csharp
             await _hubContext.Clients.Group($"user_{userId}").SendAsync("SigningProgress", new
             {
                 current = i + 1,
                 total = request.DocumentIds.Count,
                 documentId = request.DocumentIds[i].ToString(),
                 success = signResult.Success
             });
             ```
           - On failure: catch exception, add to failed list, CONTINUE signing remaining (per user decision: partial failure continues).
         - After loop completes, send "SigningComplete" event:
           ```csharp
           await _hubContext.Clients.Group($"user_{userId}").SendAsync("SigningComplete", new
           {
               total = result.Total,
               succeeded = result.Succeeded,
               failed = result.Failed
           });
           ```
         - Return `BatchSignResponse`.

    2. **Complete `DigitalSignatureService.SignDocumentAsync`** implementation:
       - Get active Pkcs11 session from `Pkcs11SessionManager`.
       - Based on `request.DocumentType`, call the appropriate `IPdfGenerationService` method to get HTML bytes:
         - "EMR": `GenerateEmrPdfAsync(request.DocumentId, "summary")` (or specific formType if provided in request)
         - "Prescription": `GeneratePrescriptionAsync(request.DocumentId)`
         - "LabResult": `GenerateLabResultAsync(request.DocumentId)`
         - "Discharge": `GenerateDischargeLetterAsync(request.DocumentId)`
         - "Referral": `GenerateEmrPdfAsync(request.DocumentId, "referral")` (or a new method if needed)
         - "Radiology": Use existing `PdfSignatureService.GenerateRadiologyReportPdfAsync` then sign.
       - Call `PdfSignatureService.ConvertAndSignAsync(htmlBytes, session.Certificate, config, request.Reason, request.Location, signerName)`.
       - Save signed PDF to disk at path: `Reports/Signed/{DocumentType}/{documentId}_{timestamp}.pdf`.
       - Create `DocumentSignature` entity in DB with all fields populated from the signing result (signer name, cert serial, CA provider, TSA timestamp, OCSP status).
       - Return `SignDocumentResponse`.

    3. **Add document lock check**: In the `POST /sign` single-sign endpoint, before signing, check if a DocumentSignature with Status=0 (Active) already exists for this DocumentId. If yes, return 409 Conflict: "Tai lieu da duoc ky so. Can thu hoi chu ky truoc khi ky lai." Per user decision: signed documents are locked.

    4. **Add signature revocation endpoint** `POST /revoke-signature/{signatureId}`:
       - Only the signer or an admin can revoke.
       - Sets `DocumentSignature.Status = 1`, `RevokeReason`, `RevokedAt`, `RevokedByUserId`.
       - This unlocks the document for editing and re-signing.
  </action>
  <verify>
    Run: `cd C:/Source/HIS/backend && dotnet build 2>&1 | tail -5`
    Expected: Build succeeded with 0 errors.
  </verify>
  <done>
    Batch signing endpoint sends SignalR progress events per document. SignDocumentAsync generates HTML via IPdfGenerationService, converts to PDF, signs with PKCS#11+TSA+OCSP+CRL, saves to disk, creates DocumentSignature DB record. Document lock prevents re-signing without revocation. Revocation endpoint exists for unlock flow.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate signing UI into EMR, Prescription, Laboratory pages and create Cypress E2E tests</name>
  <files>
    frontend/src/pages/EMR.tsx
    frontend/src/pages/Prescription.tsx
    frontend/src/pages/Laboratory.tsx
    frontend/src/App.tsx
    frontend/cypress/e2e/digital-signature.cy.ts
  </files>
  <action>
    1. **Wrap App with SigningProvider** in `frontend/src/App.tsx`:
       - Import `SigningProvider` from `../contexts/SigningContext`.
       - Wrap the router/routes section (inside NotificationProvider, after auth) with `<SigningProvider>`.

    2. **Integrate signing into `EMR.tsx`** (~40 lines of additions):
       - Import `SignatureStatusIcon`, `PinEntryModal`, `BatchSigningModal`, `SignatureVerificationPanel`, `useSigningContext`.
       - In the examination table (left panel), add a column "Chu ky" showing `<SignatureStatusIcon>` per row. To get signature status, call `getSignatureInfo(examination.id)` on row selection or batch-load for visible rows.
       - In the detail panel header (right panel, next to print buttons), add:
         - "Ky so" button (primary, with `EditOutlined` icon): Opens `PinEntryModal` to sign the current examination's selected form.
         - "Ky hang loat" button (default): Opens `BatchSigningModal` with all unsigned examinations from the table (user can select with checkboxes).
       - Add state: `pinModalOpen`, `batchModalOpen`, `verificationPanelOpen`, `selectedSignature`.
       - When document is signed (has active signature): hide "Sua" edit buttons, hide "Xoa" delete buttons. Show "Thu hoi chu ky" action to unlock.
       - Show `SignatureVerificationPanel` drawer when user clicks on the green shield icon.

    3. **Integrate signing into `Prescription.tsx`** (~30 lines of additions):
       - Add `SignatureStatusIcon` in the prescription list table (actions column).
       - Add "Ky don thuoc" button in prescription detail actions (next to print).
       - When prescription is signed: disable edit actions, show "Da ky" tag.
       - Batch signing from prescription list: checkbox selection + "Ky tat ca don chua ky" button.

    4. **Integrate signing into `Laboratory.tsx`** (~30 lines of additions):
       - Add `SignatureStatusIcon` in the lab results table (actions column).
       - Add "Ky ket qua" button on approved/finalized lab results.
       - When lab result is signed: lock the result from further edits.
       - Batch signing: select multiple approved results and sign at once.

    5. **Create `frontend/cypress/e2e/digital-signature.cy.ts`** (~100 lines): Cypress E2E tests for the signing UI.
       - **API endpoint tests** (6 tests):
         - `POST /api/digital-signature/open-session` with invalid PIN returns error (no real token needed)
         - `GET /api/digital-signature/session-status` returns `{ active: false }` when no session
         - `POST /api/digital-signature/sign` without session returns 401
         - `POST /api/digital-signature/batch-sign` with >50 docs returns 400
         - `GET /api/digital-signature/signatures/{randomGuid}` returns empty/404
         - `POST /api/digital-signature/close-session` succeeds (no-op when no session)
       - **UI component tests** (8 tests):
         - EMR page loads with "Ky so" button visible (if examination selected)
         - EMR page loads with "Ky hang loat" button visible
         - Prescription page has signing action in table
         - Laboratory page has signing action in table
         - PinEntryModal opens when clicking "Ky so" on EMR page (mock or intercept API)
         - BatchSigningModal opens showing document count
         - SignatureStatusIcon shows gray icon for unsigned documents
         - SignatureVerificationPanel drawer opens on mock signed document
       - **Integration tests** (3 tests):
         - Mock `POST /digital-signature/open-session` to return success, verify session status updates
         - Mock `POST /digital-signature/sign` to return success, verify green shield appears
         - Mock `POST /digital-signature/batch-sign` to return partial success, verify progress and red/green icons
       - Use `cy.intercept` to mock signing API responses (no real USB Token in CI).
       - Add `console.warn` patterns to IGNORE_PATTERNS if needed (signing API 4xx is expected without token).
  </action>
  <verify>
    Run: `cd C:/Source/HIS/frontend && npx tsc --noEmit 2>&1 | tail -10`
    Expected: 0 TypeScript errors.
    Run: `cd C:/Source/HIS/frontend && npx vite build 2>&1 | tail -5`
    Expected: Build succeeds.
    Run: `cd C:/Source/HIS/frontend && npx cypress run --spec "cypress/e2e/digital-signature.cy.ts" --browser chrome 2>&1 | tail -20`
    Expected: All tests pass (using mocked API responses).
  </verify>
  <done>
    EMR page has "Ky so" and "Ky hang loat" buttons with full signing flow. Prescription and Laboratory pages have signing integration in table actions. Signed documents show green shield, unsigned show gray. Signed documents are locked (edit/delete hidden). Cypress tests verify all API endpoints and UI components with mocked responses. App.tsx wraps routes with SigningProvider.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds with 0 errors
2. `npx tsc --noEmit` succeeds with 0 errors
3. `npx vite build` succeeds
4. Cypress digital-signature tests all pass
5. EMR, Prescription, Laboratory pages render signing UI elements
6. Batch signing endpoint sends SignalR progress events
7. Document lock prevents editing signed documents
</verification>

<success_criteria>
- Doctor can click "Ky so" on EMR page and see PinEntryModal
- Doctor can select multiple documents and click "Ky hang loat" to open BatchSigningModal
- SignatureStatusIcon shows correctly in EMR, Prescription, Laboratory tables
- Batch signing sends real-time SignalR progress events during signing loop
- Signed documents show green shield; unsigned show gray shield
- Signed documents are locked (edit/delete actions hidden)
- Cypress tests pass with mocked API (no real USB Token needed for CI)
- Backend builds with full batch signing + document lock + revocation endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/02-digital-signature-expansion-pkcs-11-tsa/02-04-SUMMARY.md`
</output>
